<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM ç³»çµ±</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>CRM ç³»çµ±</h1>
                <p>é¡§å®¢é—œä¿‚ç®¡ç†</p>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px;">
                    <span id="user-info" style="opacity: 0.8;"></span>
                    <button onclick="logout()" style="margin-left: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">ç™»å‡º</button>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a class="nav-item active" data-page="dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        å„€è¡¨æ¿
                    </a>
                    <a class="nav-item" data-page="customers">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        é¡§å®¢åˆ—è¡¨
                    </a>
                    <a class="nav-item" data-page="courses">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        èª²ç¨‹ç®¡ç†
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">æ•¸æ“šåˆ†æ</div>
                    <a class="nav-item" data-page="analysis">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        è³¼è²·åˆ†æ
                    </a>
                    <a class="nav-item" data-page="conversion">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        è½‰æ›ç‡åˆ†æ
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">è¡ŒéŠ·å·¥å…·</div>
                    <a class="nav-item" data-page="greeting">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        ç¯€æ…¶ç¥è³€
                    </a>
                    <a class="nav-item" data-page="campaigns">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                        </svg>
                        å»£å‘Šæ´»å‹•
                    </a>
                    <a class="nav-item" data-page="schedules">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        æ’ç¨‹ç®¡ç†
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">ç³»çµ±ç®¡ç†</div>
                    <a class="nav-item" data-page="import">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        åŒ¯å…¥è³‡æ–™
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div id="page-content">
                <div class="loading">
                    <div class="spinner"></div>
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </main>
    </div>

    <script>
        // API Base URL
        const API_BASE = '';

        // Page templates
        const pages = {
            dashboard: async () => {
                const data = await fetchAPI('/analysis/activity-correlation');
                return `
                    <div class="page-header">
                        <h2>å„€è¡¨æ¿</h2>
                        <p>CRM ç³»çµ±ç¸½è¦½</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">å®Œæ•´èª²ç¨‹åƒèˆ‡</div>
                                    <div class="card-value">${data.summary['å®Œæ•´èª²ç¨‹']['åƒèˆ‡äººæ•¸']}</div>
                                    <div class="card-subtitle">è³¼è²·ç‡ ${data.summary['å®Œæ•´èª²ç¨‹']['è³¼è²·ç‡']}</div>
                                </div>
                                <div class="card-icon blue">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">é«”é©—èª²ç¨‹åƒèˆ‡</div>
                                    <div class="card-value">${data.summary['é«”é©—èª²ç¨‹']['åƒèˆ‡äººæ•¸']}</div>
                                    <div class="card-subtitle">è³¼è²·ç‡ ${data.summary['é«”é©—èª²ç¨‹']['è³¼è²·ç‡']}</div>
                                </div>
                                <div class="card-icon green">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">å®Œæ•´èª²ç¨‹è³¼è²·</div>
                                    <div class="card-value">${data.summary['å®Œæ•´èª²ç¨‹']['è³¼è²·äººæ•¸']}</div>
                                    <div class="card-subtitle">äºº</div>
                                </div>
                                <div class="card-icon orange">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">é«”é©—èª²ç¨‹è³¼è²·</div>
                                    <div class="card-value">${data.summary['é«”é©—èª²ç¨‹']['è³¼è²·äººæ•¸']}</div>
                                    <div class="card-subtitle">äºº</div>
                                </div>
                                <div class="card-icon teal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="insights-container">
                        <div class="insights-title">æ•¸æ“šæ´å¯Ÿ</div>
                        ${data.insights.map(insight => `
                            <div class="insight-item">
                                <div class="insight-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="insight-text">${insight}</div>
                            </div>
                        `).join('')}
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div class="insight-text">åŒæ™‚åƒåŠ å…©ç¨®èª²ç¨‹çš„é¡§å®¢æ•¸ï¼š${data.customer_overlap['åŒæ™‚åƒåŠ å…©ç¨®èª²ç¨‹çš„é¡§å®¢æ•¸']} äºº</div>
                        </div>
                    </div>
                `;
            },

            customers: async () => {
                const data = await fetchAPI('/customers/');
                window.customerData = data; // å„²å­˜è³‡æ–™ä¾›æ’åºä½¿ç”¨
                return `
                    <div class="page-header">
                        <h2>é¡§å®¢åˆ—è¡¨</h2>
                        <p>æ‰€æœ‰é¡§å®¢åŠå…¶æ´»å‹•åƒèˆ‡è¨˜éŒ„</p>
                    </div>

                    <!-- å·¥å…·åˆ— -->
                    <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
                        <button onclick="openAddCustomerModal()" style="padding:10px 20px;background:linear-gradient(135deg,#4a9595,#5CADAD);color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;">
                            + æ–°å¢é¡§å®¢
                        </button>
                        <button onclick="deleteSelectedCustomers()" id="delete-selected-btn" style="padding:10px 20px;background:#e53e3e;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;display:none;">
                            åˆªé™¤é¸å– (<span id="selected-count">0</span>)
                        </button>
                        <button onclick="deleteAllCustomers()" style="padding:10px 20px;background:white;color:#e53e3e;border:1px solid #e53e3e;border-radius:8px;cursor:pointer;font-size:14px;">
                            åˆªé™¤å…¨éƒ¨
                        </button>
                        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
                            <label style="font-size:14px;color:#666;">æ’åºï¼š</label>
                            <select id="sort-field" onchange="sortCustomers()" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px;">
                                <option value="name">å§“å</option>
                                <option value="phone">é›»è©±</option>
                                <option value="birthday">ç”Ÿæ—¥</option>
                                <option value="created_at" selected>å»ºç«‹æ™‚é–“</option>
                                <option value="activity_time">æ´»å‹•æ™‚é–“</option>
                            </select>
                            <select id="sort-order" onchange="sortCustomers()" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px;">
                                <option value="desc">æ–°â†’èˆŠ</option>
                                <option value="asc">èˆŠâ†’æ–°</option>
                            </select>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">é¡§å®¢è³‡æ–™ (<span id="customer-count">${data.length}</span> ç­†)</div>
                        </div>
                        <div style="max-height:500px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px;">
                            <table style="width:100%;">
                                <thead style="position:sticky;top:0;background:white;z-index:10;box-shadow:0 1px 2px rgba(0,0,0,0.1);">
                                    <tr>
                                        <th style="width:40px;"><input type="checkbox" id="select-all" onchange="toggleSelectAll(this)"></th>
                                        <th>å§“å</th>
                                        <th>é›»è©±</th>
                                        <th>Email</th>
                                        <th>ç”Ÿæ—¥</th>
                                        <th>å®Œæ•´èª²ç¨‹</th>
                                        <th>é«”é©—èª²ç¨‹</th>
                                        <th style="width:80px;white-space:nowrap;">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="customer-tbody">
                                    ${renderCustomerRows(data)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- æ–°å¢é¡§å®¢ Modal -->
                    <div id="add-customer-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:450px;width:90%;padding:24px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                <h3 style="margin:0;">æ–°å¢é¡§å®¢</h3>
                                <button onclick="closeAddCustomerModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                            </div>
                            <form id="add-customer-form">
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">å§“å *</label>
                                    <input type="text" name="name" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">é›»è©± *</label>
                                    <input type="tel" name="phone" required pattern="[0-9]{10}" placeholder="0912345678" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">Email</label>
                                    <input type="email" name="email" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">ç”Ÿæ—¥</label>
                                    <input type="date" name="birthday" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">èª²ç¨‹æ­¸é¡</label>
                                    <div style="display:flex;gap:12px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="checkbox" name="complete_course" value="1">
                                            <span>å®Œæ•´èª²ç¨‹</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="checkbox" name="experience_course" value="1">
                                            <span>é«”é©—èª²ç¨‹</span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display:flex;gap:12px;justify-content:flex-end;">
                                    <button type="button" onclick="closeAddCustomerModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;">å–æ¶ˆ</button>
                                    <button type="submit" style="padding:10px 20px;border:none;border-radius:6px;background:#4a9595;color:white;cursor:pointer;">æ–°å¢</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- ç·¨è¼¯é¡§å®¢ Modal -->
                    <div id="edit-customer-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:500px;width:90%;padding:24px;max-height:90vh;overflow-y:auto;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                <h3 style="margin:0;">ç·¨è¼¯é¡§å®¢</h3>
                                <button onclick="closeEditCustomerModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                            </div>
                            <form id="edit-customer-form">
                                <input type="hidden" name="customer_id">
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">å§“å *</label>
                                    <input type="text" name="name" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">é›»è©± *</label>
                                    <input type="tel" name="phone" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">Email</label>
                                    <input type="email" name="email" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">ç”Ÿæ—¥</label>
                                    <input type="date" name="birthday" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                </div>
                                <div style="margin-bottom:16px;padding:16px;background:#f7fafc;border-radius:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">å®Œæ•´èª²ç¨‹</label>
                                    <div style="display:flex;gap:16px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="checkbox" name="complete_course" value="1">
                                            <span>å·²åƒåŠ </span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="checkbox" name="complete_purchased" value="1">
                                            <span>å·²è³¼è²·</span>
                                        </label>
                                    </div>
                                </div>
                                <div style="margin-bottom:16px;padding:16px;background:#f7fafc;border-radius:8px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">é«”é©—èª²ç¨‹</label>
                                    <div style="display:flex;gap:16px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="checkbox" name="experience_course" value="1">
                                            <span>å·²åƒåŠ </span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="checkbox" name="experience_purchased" value="1">
                                            <span>å·²è³¼è²·</span>
                                        </label>
                                    </div>
                                </div>
                                <div style="display:flex;gap:12px;justify-content:flex-end;">
                                    <button type="button" onclick="closeEditCustomerModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;">å–æ¶ˆ</button>
                                    <button type="submit" style="padding:10px 20px;border:none;border-radius:6px;background:#5CADAD;color:white;cursor:pointer;">å„²å­˜è®Šæ›´</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            courses: async () => {
                const complete = await fetchAPI('/customers/');
                const completeCourse = complete.filter(c => c.complete_course_participations.length > 0);
                const experienceCourse = complete.filter(c => c.experience_course_participations.length > 0);
                const completePurchased = complete.filter(c => c.purchased_from_complete).length;
                const experiencePurchased = complete.filter(c => c.purchased_from_experience).length;

                return `
                    <div class="page-header">
                        <h2>èª²ç¨‹ç®¡ç†</h2>
                        <p>èª²ç¨‹åƒèˆ‡ç‹€æ³</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">è–èª•ç¯€è›‹ç³•è£½ä½œå®Œæ•´èª²ç¨‹</div>
                            <div class="card-value">${completeCourse.length} <span style="font-size:1rem;color:#666">äººåƒèˆ‡</span></div>
                            <div class="card-subtitle">å·²è³¼è²·ï¼š${completePurchased} äºº</div>
                        </div>
                        <div class="card">
                            <div class="card-title">è–èª•ç¯€è›‹ç³•è£½ä½œé«”é©—èª²ç¨‹</div>
                            <div class="card-value">${experienceCourse.length} <span style="font-size:1rem;color:#666">äººåƒèˆ‡</span></div>
                            <div class="card-subtitle">å·²è³¼è²·ï¼š${experiencePurchased} äºº</div>
                        </div>
                    </div>
                `;
            },

            analysis: async () => {
                const data = await fetchAPI('/analysis/summary');

                // èª²ç¨‹åƒ¹æ ¼
                const COMPLETE_PRICE = 36800;
                const EXPERIENCE_PRICE = 600;

                // è¨ˆç®—æ”¶å…¥
                const completeRevenue = data.complete_course_purchased_count * COMPLETE_PRICE;
                const experienceRevenue = data.experience_course_purchased_count * EXPERIENCE_PRICE;
                const totalRevenue = completeRevenue + experienceRevenue;

                // å„²å­˜è³‡æ–™ä¾›åœ–è¡¨ä½¿ç”¨
                window.revenueData = {
                    completeRevenue,
                    experienceRevenue,
                    totalRevenue,
                    completePurchased: data.complete_course_purchased_count,
                    experiencePurchased: data.experience_course_purchased_count
                };

                return `
                    <div class="page-header">
                        <h2>è³¼è²·åˆ†æ</h2>
                        <p>èª²ç¨‹è³¼è²·çµ±è¨ˆèˆ‡é‡‘æµæ”¶å…¥</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">å®Œæ•´èª²ç¨‹è³¼è²·ç‡</div>
                            <div class="card-value">${data.complete_course_purchase_rate}%</div>
                            <div class="card-subtitle">${data.complete_course_purchased_count} / ${data.total_complete_course_participants} äººè³¼è²·</div>
                        </div>
                        <div class="card">
                            <div class="card-title">é«”é©—èª²ç¨‹è³¼è²·ç‡</div>
                            <div class="card-value">${data.experience_course_purchase_rate}%</div>
                            <div class="card-subtitle">${data.experience_course_purchased_count} / ${data.total_experience_course_participants} äººè³¼è²·</div>
                        </div>
                    </div>

                    <!-- é‡‘æµæ”¶å…¥å€å¡Š -->
                    <div class="card" style="margin-top:24px;">
                        <div class="card-title" style="font-size:1.1rem;font-weight:600;margin-bottom:20px;">é‡‘æµæ”¶å…¥çµ±è¨ˆ</div>
                        <div style="display:flex;gap:40px;align-items:center;flex-wrap:wrap;">
                            <div style="width:250px;height:250px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <div style="flex:1;min-width:280px;">
                                <div style="background:#f8fafa;border-radius:12px;padding:20px;margin-bottom:16px;">
                                    <div style="font-size:14px;color:#666;margin-bottom:8px;">ç¸½æ”¶å…¥</div>
                                    <div style="font-size:32px;font-weight:700;color:#4a9595;">NT$ ${totalRevenue.toLocaleString()}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <div style="background:#e8f5f5;border-radius:8px;padding:16px;">
                                        <div style="font-size:12px;color:#666;margin-bottom:4px;">å®Œæ•´èª²ç¨‹æ”¶å…¥</div>
                                        <div style="font-size:20px;font-weight:600;color:#4a9595;">NT$ ${completeRevenue.toLocaleString()}</div>
                                        <div style="font-size:12px;color:#888;margin-top:4px;">${data.complete_course_purchased_count} äºº Ã— NT$${COMPLETE_PRICE.toLocaleString()}</div>
                                    </div>
                                    <div style="background:#fef5e7;border-radius:8px;padding:16px;">
                                        <div style="font-size:12px;color:#666;margin-bottom:4px;">é«”é©—èª²ç¨‹æ”¶å…¥</div>
                                        <div style="font-size:20px;font-weight:600;color:#dd6b20;">NT$ ${experienceRevenue.toLocaleString()}</div>
                                        <div style="font-size:12px;color:#888;margin-top:4px;">${data.experience_course_purchased_count} äºº Ã— NT$${EXPERIENCE_PRICE.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="insights-container">
                        <div class="insights-title">é¡§å®¢é‡ç–Šåˆ†æ</div>
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div class="insight-text">åŒæ™‚åƒåŠ å…©ç¨®èª²ç¨‹ï¼š${data.customers_in_both} äºº</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <div class="insight-text">åªåƒåŠ å®Œæ•´èª²ç¨‹ï¼š${data.customers_only_complete} äºº</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="insight-text">åªåƒåŠ é«”é©—èª²ç¨‹ï¼š${data.customers_only_experience} äºº</div>
                        </div>
                    </div>
                `;
            },

            conversion: async () => {
                const data = await fetchAPI('/analysis/conversion');
                return `
                    <div class="page-header">
                        <h2>è½‰æ›ç‡åˆ†æ</h2>
                        <p>é«”é©—èª²ç¨‹åˆ°å®Œæ•´èª²ç¨‹çš„è½‰æ›è¿½è¹¤</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">é«”é©—èª²ç¨‹åƒèˆ‡è€…</div>
                            <div class="card-value">${data.experience_participants}</div>
                            <div class="card-subtitle">äºº</div>
                        </div>
                        <div class="card">
                            <div class="card-title">é«”é©—å¾Œè³¼è²·å®Œæ•´èª²ç¨‹</div>
                            <div class="card-value">${data.experience_to_complete_purchase}</div>
                            <div class="card-subtitle">äºº</div>
                        </div>
                        <div class="card">
                            <div class="card-title">è½‰æ›ç‡</div>
                            <div class="card-value">${data.experience_to_complete_rate}%</div>
                            <div class="card-subtitle">é«”é©— â†’ å®Œæ•´èª²ç¨‹</div>
                        </div>
                        <div class="card">
                            <div class="card-title">åƒ…é«”é©—èª²ç¨‹è³¼è²·</div>
                            <div class="card-value">${data.experience_only_purchased}</div>
                            <div class="card-subtitle">äºº</div>
                        </div>
                    </div>
                `;
            },

            greeting: async () => {
                const [festivals, customers] = await Promise.all([
                    fetchAPI('/email/festivals'),
                    fetchAPI('/customers/')
                ]);

                return `
                    <div class="page-header">
                        <h2>ç¯€æ…¶ç¥è³€</h2>
                        <p>ç™¼é€ç¯€æ…¶ç¥è³€ä¿¡çµ¦é¡§å®¢</p>
                    </div>

                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title" style="margin-bottom: 16px;">é¸æ“‡ç¯€æ…¶</div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            ${festivals.map(f => `
                                <button class="festival-btn" data-festival="${f.id}" style="
                                    padding: 12px 24px;
                                    border: 2px solid #e2e8f0;
                                    border-radius: 8px;
                                    background: white;
                                    cursor: pointer;
                                    font-size: 16px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.borderColor='#5CADAD'" onmouseout="this.style.borderColor=this.classList.contains('selected')?'#5CADAD':'#e2e8f0'">
                                    ${f.emoji} ${f.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title" style="margin-bottom: 16px;">è‡ªè¨‚è¨Šæ¯ï¼ˆé¸å¡«ï¼‰</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ‰')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ‰</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ„')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ„</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ§§')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ§§</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ‚')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ‚</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('â¤ï¸')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">â¤ï¸</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('âœ¨')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">âœ¨</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸŒŸ')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸŒŸ</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ’')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ’</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸŠ')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸŠ</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ¥³')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ¥³</button>
                            <button type="button" class="emoji-btn" onclick="insertEmoji('ğŸ’°')" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;font-size:18px;">ğŸ’°</button>
                        </div>
                        <textarea id="custom-message" placeholder="è¼¸å…¥é¡å¤–çš„ç¥ç¦è¨Šæ¯..." style="
                            width: 100%;
                            min-height: 250px;
                            padding: 12px;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            font-size: 14px;
                            line-height: 1.6;
                            resize: vertical;
                            box-sizing: border-box;
                        "></textarea>
                    </div>

                    <div class="card" style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="card-title">é¸æ“‡é¡§å®¢</div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="select-all" style="width: 18px; height: 18px;">
                                å…¨é¸
                            </label>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${customers.filter(c => c.email).map(c => `
                                <label style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                                    <input type="checkbox" class="customer-checkbox" value="${c.id}" style="width: 18px; height: 18px;">
                                    <span style="flex: 1;">${c.name}</span>
                                    <span style="color: #666; font-size: 14px;">${c.email}</span>
                                </label>
                            `).join('')}
                        </div>
                        <p style="color: #666; font-size: 14px; margin-top: 12px;">
                            å…± ${customers.filter(c => c.email).length} ä½é¡§å®¢æœ‰ Email
                        </p>
                    </div>

                    <button id="send-greeting-btn" style="
                        background: linear-gradient(135deg, #4a9595 0%, #5CADAD 100%);
                        color: white;
                        border: none;
                        padding: 14px 32px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        ç™¼é€ç¥è³€ä¿¡
                    </button>

                    <div id="send-result" style="margin-top: 24px;"></div>
                `;
            },

            campaigns: async () => {
                const campaigns = await fetchAPI('/campaigns/');
                const statusMap = {
                    'draft': { text: 'è‰ç¨¿', class: 'badge-warning' },
                    'scheduled': { text: 'å·²æ’ç¨‹', class: 'badge-info' },
                    'sending': { text: 'ç™¼é€ä¸­', class: 'badge-info' },
                    'completed': { text: 'å·²å®Œæˆ', class: 'badge-success' },
                    'cancelled': { text: 'å·²å–æ¶ˆ', class: 'badge-error' }
                };

                return `
                    <div class="page-header">
                        <h2>å»£å‘Šæ´»å‹•</h2>
                        <p>å»ºç«‹å’Œç®¡ç†è¡ŒéŠ·å»£å‘Šæ´»å‹•</p>
                    </div>

                    <button id="create-campaign-btn" style="
                        background: linear-gradient(135deg, #4a9595 0%, #5CADAD 100%);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        margin-bottom: 24px;
                    ">+ å»ºç«‹æ–°æ´»å‹•</button>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">æ´»å‹•åˆ—è¡¨ (${campaigns.length} ç­†)</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>æ´»å‹•åç¨±</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>ç¯©é¸æ¢ä»¶</th>
                                    <th>æ”¶ä»¶äººæ•¸</th>
                                    <th>å·²ç™¼é€</th>
                                    <th>é»æ“Šç‡</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.length === 0 ? `
                                    <tr><td colspan="7" style="text-align:center;color:#666;">å°šç„¡æ´»å‹•</td></tr>
                                ` : campaigns.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td><span class="badge ${statusMap[c.status]?.class || ''}">${statusMap[c.status]?.text || c.status}</span></td>
                                        <td style="font-size:12px;color:#666;">
                                            ${c.course_type_filter === 'all' ? 'å…¨éƒ¨èª²ç¨‹' : c.course_type_filter === 'complete' ? 'å®Œæ•´èª²ç¨‹' : 'é«”é©—èª²ç¨‹'}
                                            /
                                            ${c.purchase_status_filter === 'all' ? 'å…¨éƒ¨' : c.purchase_status_filter === 'purchased' ? 'å·²è³¼è²·' : 'æœªè³¼è²·'}
                                        </td>
                                        <td>${c.total_recipients}</td>
                                        <td>${c.sent_count}</td>
                                        <td>${c.sent_count > 0 ? Math.round((c.sent_count - c.failed_count) / c.sent_count * 100) : 0}%</td>
                                        <td>
                                            <button onclick="viewCampaignStats(${c.id})" style="padding:4px 8px;font-size:12px;cursor:pointer;">çµ±è¨ˆ</button>
                                            ${c.status === 'draft' ? `
                                                <button onclick="sendCampaignNow(${c.id})" style="padding:4px 8px;font-size:12px;cursor:pointer;background:#5CADAD;color:white;border:none;border-radius:4px;">ç™¼é€</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div id="campaign-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;padding:24px;">
                            <h3 style="margin:0 0 20px;">å»ºç«‹å»£å‘Šæ´»å‹•</h3>
                            <form id="campaign-form">
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">æ´»å‹•åç¨±</label>
                                    <input type="text" name="name" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">éƒµä»¶ä¸»æ—¨</label>
                                    <input type="text" name="subject" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                </div>

                                <!-- æ”¶ä»¶äººé¸æ“‡å€ -->
                                <div style="background:#f7fafc;border-radius:8px;padding:16px;margin-bottom:16px;">
                                    <div style="font-weight:500;margin-bottom:12px;">æ”¶ä»¶äººè¨­å®š</div>

                                    <!-- é¸æ“‡æ–¹å¼ -->
                                    <div style="display:flex;gap:16px;margin-bottom:12px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="recipient_mode" value="filter" checked onchange="toggleRecipientMode(this.value)">
                                            <span>ä½¿ç”¨ç¯©é¸æ¢ä»¶</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="recipient_mode" value="manual" onchange="toggleRecipientMode(this.value)">
                                            <span>æ‰‹å‹•é¸æ“‡</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="recipient_mode" value="both" onchange="toggleRecipientMode(this.value)">
                                            <span>å…©è€…çš†ç”¨</span>
                                        </label>
                                    </div>

                                    <!-- ç¯©é¸æ¢ä»¶å€å¡Š -->
                                    <div id="filter-section" style="display:flex;gap:16px;margin-bottom:12px;">
                                        <div style="flex:1;">
                                            <label style="display:block;margin-bottom:4px;font-size:13px;">èª²ç¨‹é¡å‹</label>
                                            <select name="course_type_filter" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
                                                <option value="all">å…¨éƒ¨</option>
                                                <option value="complete">å®Œæ•´èª²ç¨‹</option>
                                                <option value="experience">é«”é©—èª²ç¨‹</option>
                                            </select>
                                        </div>
                                        <div style="flex:1;">
                                            <label style="display:block;margin-bottom:4px;font-size:13px;">è³¼è²·ç‹€æ…‹</label>
                                            <select name="purchase_status_filter" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
                                                <option value="all">å…¨éƒ¨</option>
                                                <option value="purchased">å·²è³¼è²·</option>
                                                <option value="not_purchased">æœªè³¼è²·</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- æ‰‹å‹•é¸æ“‡å€å¡Š -->
                                    <div id="manual-section" style="display:none;">
                                        <label style="display:block;margin-bottom:4px;font-size:13px;">é¸æ“‡å­¸å“¡</label>
                                        <div id="customer-list" style="max-height:150px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:white;margin-bottom:12px;"></div>

                                        <label style="display:block;margin-bottom:4px;font-size:13px;">é¡å¤– Emailï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                                        <textarea name="additional_emails" rows="3" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;" placeholder="email1@example.com&#10;email2@example.com"></textarea>
                                    </div>
                                </div>

                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">éƒµä»¶å…§å®¹ (HTML)</label>
                                    <textarea name="content" rows="8" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;font-family:monospace;" placeholder="<h1>æ¨™é¡Œ</h1>
<p>è¦ªæ„›çš„ {{name}} æ‚¨å¥½ï¼Œ</p>
<p>å…§å®¹...</p>
<a href='https://example.com'>é»æ­¤äº†è§£æ›´å¤š</a>"></textarea>
                                    <p style="font-size:12px;color:#666;margin-top:4px;">ä½¿ç”¨ {{name}} æ’å…¥æ”¶ä»¶äººå§“å</p>
                                </div>
                                <div style="display:flex;gap:12px;justify-content:flex-end;">
                                    <button type="button" onclick="closeCampaignModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;">å–æ¶ˆ</button>
                                    <button type="submit" style="padding:10px 20px;border:none;border-radius:6px;background:#4a9595;color:white;cursor:pointer;">å»ºç«‹æ´»å‹•</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="stats-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:500px;width:90%;padding:24px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                <h3 style="margin:0;">æ´»å‹•çµ±è¨ˆ</h3>
                                <button onclick="closeStatsModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                            </div>
                            <div id="stats-content"></div>
                        </div>
                    </div>
                `;
            },

            schedules: async () => {
                const schedules = await fetchAPI('/schedules/');
                const statusMap = {
                    'pending': { text: 'å¾…åŸ·è¡Œ', class: 'badge-warning' },
                    'running': { text: 'åŸ·è¡Œä¸­', class: 'badge-info' },
                    'completed': { text: 'å·²å®Œæˆ', class: 'badge-success' },
                    'failed': { text: 'å¤±æ•—', class: 'badge-error' },
                    'cancelled': { text: 'å·²å–æ¶ˆ', class: 'badge-error' }
                };

                return `
                    <div class="page-header">
                        <h2>æ’ç¨‹ç®¡ç†</h2>
                        <p>ç®¡ç†è‡ªå‹•åŒ–ä»»å‹™å’Œæ’ç¨‹</p>
                    </div>

                    <button id="create-schedule-btn" style="
                        background: linear-gradient(135deg, #4a9595 0%, #5CADAD 100%);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        margin-bottom: 24px;
                    ">+ æ–°å¢é‡è¤‡æ’ç¨‹</button>

                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">å¾…åŸ·è¡Œä»»å‹™</div>
                            <div class="card-value">${schedules.filter(s => s.status === 'pending').length}</div>
                        </div>
                        <div class="card">
                            <div class="card-title">é‡è¤‡ä»»å‹™</div>
                            <div class="card-value">${schedules.filter(s => s.is_recurring).length}</div>
                        </div>
                        <div class="card">
                            <div class="card-title">å·²å®Œæˆ</div>
                            <div class="card-value">${schedules.filter(s => s.status === 'completed').length}</div>
                        </div>
                    </div>

                    <div class="table-container" style="margin-top:24px;">
                        <div class="table-header">
                            <div class="table-title">æ’ç¨‹ä»»å‹™åˆ—è¡¨</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»»å‹™é¡å‹</th>
                                    <th>èªªæ˜</th>
                                    <th>æ’ç¨‹æ™‚é–“</th>
                                    <th>ä¸‹æ¬¡åŸ·è¡Œ</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${schedules.length === 0 ? `
                                    <tr><td colspan="6" style="text-align:center;color:#666;">å°šç„¡æ’ç¨‹ä»»å‹™</td></tr>
                                ` : schedules.map(s => {
                                    const taskTypeMap = {
                                        'campaign': 'å»£å‘Šæ´»å‹•',
                                        'campaign_send': 'å»£å‘Šæ´»å‹•ç™¼é€',
                                        'birthday_greeting': 'ç”Ÿæ—¥ç¥è³€',
                                        'reminder_email': 'æé†’éƒµä»¶'
                                    };
                                    const taskTypeName = taskTypeMap[s.task_type] || s.task_type;
                                    return `
                                    <tr>
                                        <td>${taskTypeName}</td>
                                        <td>${s.description || '-'}</td>
                                        <td>${s.scheduled_at ? new Date(s.scheduled_at).toLocaleString('zh-TW') : (s.cron_expression || '-')}</td>
                                        <td>${s.next_run_at ? new Date(s.next_run_at).toLocaleString('zh-TW') : '-'}</td>
                                        <td><span class="badge ${statusMap[s.status]?.class || ''}">${statusMap[s.status]?.text || s.status}</span></td>
                                        <td>
                                            ${s.status === 'pending' ? `
                                                <button onclick="cancelSchedule('${s.job_id}')" style="padding:4px 8px;font-size:12px;cursor:pointer;background:#e53e3e;color:white;border:none;border-radius:4px;">å–æ¶ˆ</button>
                                            ` : '-'}
                                        </td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- æ–°å¢æ’ç¨‹å°è©±æ¡† -->
                    <div id="schedule-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:550px;width:90%;max-height:90vh;overflow-y:auto;padding:24px;">
                            <h3 style="margin:0 0 20px;">æ–°å¢æ’ç¨‹</h3>
                            <form id="schedule-form">
                                <!-- æ’ç¨‹é¡å‹ -->
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">æ’ç¨‹é¡å‹</label>
                                    <div style="display:flex;gap:16px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="schedule_type" value="once" checked onchange="toggleScheduleType(this.value)">
                                            <span>å–®æ¬¡åŸ·è¡Œ</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="schedule_type" value="recurring" onchange="toggleScheduleType(this.value)">
                                            <span>é‡è¤‡åŸ·è¡Œ</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- ä»»å‹™é¡å‹ -->
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">ä»»å‹™é¡å‹</label>
                                    <div style="display:flex;gap:8px;">
                                        <select id="task-type-select" name="task_type" style="flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                            <option value="birthday_greeting">ç”Ÿæ—¥ç¥è³€éƒµä»¶</option>
                                            <option value="campaign_send">å»£å‘Šæ´»å‹•ç™¼é€</option>
                                            <option value="reminder_email">æé†’éƒµä»¶</option>
                                            <option value="custom">è‡ªè¨‚ä»»å‹™...</option>
                                        </select>
                                    </div>
                                    <div id="custom-task-type" style="display:none;margin-top:8px;">
                                        <input type="text" id="custom-task-input" placeholder="è¼¸å…¥è‡ªè¨‚ä»»å‹™åç¨±" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                    </div>
                                </div>

                                <!-- æ’ç¨‹èªªæ˜ -->
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">æ’ç¨‹èªªæ˜</label>
                                    <input type="text" name="description" required placeholder="ä¾‹å¦‚ï¼šç™¼é€æ–°å¹´ä¿ƒéŠ·æ´»å‹•" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                </div>

                                <!-- æ”¶ä»¶äººè¨­å®šï¼ˆéç”Ÿæ—¥ç¥è³€æ™‚é¡¯ç¤ºï¼‰ -->
                                <div id="recipient-section" style="display:none;background:#f7fafc;border-radius:8px;padding:16px;margin-bottom:16px;">
                                    <div style="font-weight:500;margin-bottom:12px;">æ”¶ä»¶äººè¨­å®š</div>

                                    <label style="display:block;margin-bottom:4px;font-size:13px;">é¸æ“‡é¡§å®¢</label>
                                    <div id="schedule-customer-list" style="max-height:120px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:white;margin-bottom:12px;"></div>

                                    <label style="display:block;margin-bottom:4px;font-size:13px;">é¡å¤– Emailï¼ˆæ¯è¡Œä¸€å€‹ï¼‰</label>
                                    <textarea name="additional_emails" rows="2" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;" placeholder="email1@example.com"></textarea>
                                </div>

                                <!-- éƒµä»¶å…§å®¹ï¼ˆéç”Ÿæ—¥ç¥è³€æ™‚é¡¯ç¤ºï¼‰ -->
                                <div id="email-content-section" style="display:none;margin-bottom:16px;">
                                    <div style="margin-bottom:12px;">
                                        <label style="display:block;margin-bottom:4px;font-weight:500;">éƒµä»¶ä¸»æ—¨</label>
                                        <input type="text" name="email_subject" placeholder="è¼¸å…¥éƒµä»¶ä¸»æ—¨" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:4px;font-weight:500;">éƒµä»¶å…§å®¹ (HTML)</label>
                                        <textarea name="email_content" rows="5" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;font-family:monospace;font-size:13px;" placeholder="<p>è¦ªæ„›çš„ {{name}} æ‚¨å¥½ï¼Œ</p>&#10;<p>å…§å®¹...</p>"></textarea>
                                        <p style="font-size:12px;color:#666;margin-top:4px;">ä½¿ç”¨ {{name}} æ’å…¥æ”¶ä»¶äººå§“å</p>
                                    </div>
                                </div>

                                <!-- å–®æ¬¡åŸ·è¡Œï¼šæ—¥æœŸæ™‚é–“é¸æ“‡ -->
                                <div id="once-section">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">åŸ·è¡Œæ™‚é–“</label>
                                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                                        <select name="year" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:90px;"></select>
                                        <select name="month" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <select name="day" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <select name="hour" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <div style="position:relative;">
                                            <select name="minute" id="minute-select" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        </div>
                                    </div>
                                </div>

                                <!-- é‡è¤‡åŸ·è¡Œï¼šé »ç‡è¨­å®š -->
                                <div id="recurring-section" style="display:none;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">é‡è¤‡é »ç‡</label>
                                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                                        <select name="frequency" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                            <option value="daily">æ¯å¤©</option>
                                            <option value="weekly">æ¯é€±</option>
                                            <option value="monthly">æ¯æœˆ</option>
                                        </select>
                                        <span id="weekday-select" style="display:none;">
                                            <select name="weekday" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                                <option value="1">é€±ä¸€</option>
                                                <option value="2">é€±äºŒ</option>
                                                <option value="3">é€±ä¸‰</option>
                                                <option value="4">é€±å››</option>
                                                <option value="5">é€±äº”</option>
                                                <option value="6">é€±å…­</option>
                                                <option value="0">é€±æ—¥</option>
                                            </select>
                                        </span>
                                        <span id="monthday-select" style="display:none;">
                                            <select name="monthday" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                            </select>
                                        </span>
                                    </div>
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">åŸ·è¡Œæ™‚é–“</label>
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <select name="recurring_hour" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <span>:</span>
                                        <select name="recurring_minute" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                    </div>
                                </div>

                                <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                                    <button type="button" onclick="closeScheduleModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;">å–æ¶ˆ</button>
                                    <button type="submit" style="padding:10px 20px;border:none;border-radius:6px;background:#4a9595;color:white;cursor:pointer;">å»ºç«‹æ’ç¨‹</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            import: async () => {
                return `
                    <div class="page-header">
                        <h2>åŒ¯å…¥è³‡æ–™</h2>
                        <p>ä¸Šå‚³ CSV æª”æ¡ˆåŒ¯å…¥é¡§å®¢è³‡æ–™</p>
                    </div>

                    <div class="card" style="max-width: 600px;">
                        <div class="card-title">ä¸Šå‚³ CSV æª”æ¡ˆ</div>
                        <form id="import-form" style="margin-top: 16px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display:block;margin-bottom:8px;font-weight:500;">é¸æ“‡ CSV æª”æ¡ˆ</label>
                                <input type="file" name="file" accept=".csv" required
                                    style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                <p style="margin-top:8px;font-size:12px;color:#666;">
                                    CSV æ ¼å¼ï¼šå§“å,é›»è©±,Email,ç”Ÿæ—¥
                                </p>
                            </div>

                            <button type="submit" style="
                                width: 100%;
                                padding: 12px;
                                background: linear-gradient(135deg, #4a9595 0%, #5CADAD 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                            ">åŒ¯å…¥è³‡æ–™</button>
                        </form>

                        <div id="import-result" style="margin-top: 16px; display: none;"></div>
                    </div>

                    <div class="card" style="max-width: 600px; margin-top: 24px;">
                        <div class="card-title">æ™ºæ…§åŒ¯å…¥èªªæ˜</div>
                        <div style="margin:12px 0;padding:12px;background:#e6fffa;border-radius:6px;font-size:13px;color:#234e52;">
                            <strong>è‡ªå‹•è­˜åˆ¥åŠŸèƒ½ï¼š</strong>
                            <ul style="margin:8px 0 0 16px;padding:0;">
                                <li>æ¬„ä½é †åºä¸é™ï¼Œè‡ªå‹•å°æ‡‰</li>
                                <li>å¾æª”åæå–èª²ç¨‹è³‡è¨Šï¼ˆå¦‚ã€Œè–èª•ç¯€è›‹ç³•è£½ä½œå®Œæ•´èª²ç¨‹åå–®.csvã€ï¼‰</li>
                            </ul>
                        </div>
                        <p style="margin:16px 0 8px;font-size:13px;color:#666;">å¿…è¦æ¬„ä½ï¼šå§“åã€é›»è©±</p>
                        <p style="margin:8px 0;font-size:13px;color:#666;">é¸å¡«æ¬„ä½ï¼šEmailã€ç”Ÿæ—¥ã€åƒåŠ æ´»å‹•æ™‚é–“ã€æ˜¯å¦è³¼è²·èª²ç¨‹</p>
                        <pre style="background:#f7fafc;padding:12px;border-radius:6px;font-size:12px;overflow-x:auto;margin-top:12px;">å§“å,é›»è©±,ç”Ÿæ—¥,Email,åƒåŠ æ´»å‹•æ™‚é–“,æ˜¯å¦è³¼è²·èª²ç¨‹
ç‹å°æ˜,0912345678,1990/01/15,wang@example.com,2024/12/25 14:00,æ˜¯</pre>
                        <p style="margin:12px 0 0;font-size:12px;color:#888;">
                            æç¤ºï¼šæª”ååŒ…å«ã€Œå®Œæ•´èª²ç¨‹ã€æˆ–ã€Œé«”é©—èª²ç¨‹ã€æœƒè‡ªå‹•å»ºç«‹èª²ç¨‹è¨˜éŒ„
                        </p>
                    </div>
                `;
            }
        };

        // Fetch API helper
        async function fetchAPI(endpoint) {
            const res = await fetch(API_BASE + endpoint);
            return res.json();
        }

        // Navigation
        async function navigateToPage(page) {
            // Update URL hash
            window.location.hash = page;

            // Update active state
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`[data-page="${page}"]`);
            if (activeItem) activeItem.classList.add('active');

            // Show loading
            document.getElementById('page-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    è¼‰å…¥ä¸­...
                </div>
            `;

            // Load page
            try {
                const content = await pages[page]();
                document.getElementById('page-content').innerHTML = content;

                // Page-specific initialization
                if (page === 'greeting') {
                    initGreetingPage();
                } else if (page === 'campaigns') {
                    initCampaignsPage();
                } else if (page === 'schedules') {
                    initSchedulesPage();
                } else if (page === 'import') {
                    initImportPage();
                } else if (page === 'customers') {
                    initCustomersPage();
                } else if (page === 'courses') {
                    // courses page doesn't need chart anymore
                } else if (page === 'analysis') {
                    initAnalysisPage();
                }
            } catch (error) {
                document.getElementById('page-content').innerHTML = `
                    <div class="card">
                        <div class="card-title">éŒ¯èª¤</div>
                        <p>è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${error.message}</p>
                    </div>
                `;
            }
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', async (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                await navigateToPage(page);
            });
        });

        // æ’å…¥è¡¨æƒ…ç¬¦è™Ÿåˆ°è¨Šæ¯æ¡†
        function insertEmoji(emoji) {
            const textarea = document.getElementById('custom-message');
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;

            textarea.value = text.substring(0, start) + emoji + text.substring(end);
            textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
            textarea.focus();
        }

        // Greeting page initialization
        let selectedFestival = null;

        function initGreetingPage() {
            // ç¯€æ…¶ç¯„ä¾‹è¨Šæ¯
            const festivalMessages = {
                'christmas': `ğŸ„ è–èª•å¿«æ¨‚ï¼

è¦ªæ„›çš„é¡§å®¢æ‚¨å¥½ï¼Œ

æ„Ÿè¬æ‚¨ä¸€ç›´ä»¥ä¾†çš„æ”¯æŒèˆ‡æ„›è­·ï¼
åœ¨é€™æº«é¦¨çš„è–èª•ä½³ç¯€ï¼Œæˆ‘å€‘ç”±è¡·åœ°ç¥ç¦æ‚¨ï¼š
é—”å®¶å¹³å®‰ã€å¹¸ç¦ç¾æ»¿ï¼

é¡˜é€™å€‹è–èª•ç¯€ç‚ºæ‚¨å¸¶ä¾†æ»¿æ»¿çš„å–œæ‚…èˆ‡ç¥ç¦ ğŸ

æ–°çš„ä¸€å¹´å³å°‡ä¾†è‡¨ï¼ŒæœŸå¾…ç¹¼çºŒç‚ºæ‚¨æœå‹™ï¼`,

                'new_year': `ğŸ§§ æ–°å¹´å¿«æ¨‚ï¼

è¦ªæ„›çš„é¡§å®¢æ‚¨å¥½ï¼Œ

é‡‘é¾è³€æ­²è¿æ–°æ˜¥ï¼
æ„Ÿè¬æ‚¨éå»ä¸€å¹´çš„æ”¯æŒèˆ‡ä¿¡ä»»ï¼

ç¥æ‚¨æ–°çš„ä¸€å¹´ï¼š
ğŸŠ èº«é«”å¥åº·ã€è¬äº‹å¦‚æ„
ğŸŠ è²¡æºå»£é€²ã€å¿ƒæƒ³äº‹æˆ
ğŸŠ é—”å®¶æ­¡æ¨‚ã€å¹¸ç¦ç¾æ»¿

æ­å–œç™¼è²¡ï¼ç´…åŒ…æ‹¿ä¾†ï¼`,

                'double11': `ğŸ›’ é›™11è³¼ç‰©ç¯€é©šå–œå„ªæƒ ï¼

è¦ªæ„›çš„é¡§å®¢æ‚¨å¥½ï¼Œ

ä¸€å¹´ä¸€åº¦çš„é›™11è³¼ç‰©ç¯€ä¾†å•¦ï¼ğŸ‰

æˆ‘å€‘ç‚ºæ‚¨æº–å‚™äº†è¶…å€¼å„ªæƒ ï¼š
âœ¨ å…¨é¤¨èª²ç¨‹é™æ™‚ç‰¹åƒ¹
âœ¨ æ»¿é¡å†äº«æŠ˜æ‰£
âœ¨ å¤šé‡å¥½ç¦®ç­‰æ‚¨ä¾†æ‹¿

éŒ¯éä»Šå¤©ï¼Œå†ç­‰ä¸€å¹´ï¼
è¶•å¿«æŠŠæ¡é€™æ¬¡é›£å¾—çš„å„ªæƒ æ©Ÿæœƒï¼

æ´»å‹•æœŸé–“ï¼š11/11 é™å®šä¸€å¤©`,

                'birthday': `ğŸ‚ ç”Ÿæ—¥å¿«æ¨‚ï¼

è¦ªæ„›çš„å£½æ˜Ÿæ‚¨å¥½ï¼Œ

ä»Šå¤©æ˜¯æ‚¨çš„å¤§æ—¥å­ï¼ğŸ‰
æˆ‘å€‘å…¨é«”åœ˜éšŠåœ¨æ­¤ç»ä¸Šæœ€èª æ‘¯çš„ç¥ç¦ï¼š

ğŸˆ ç”Ÿæ—¥å¿«æ¨‚ï¼
ğŸˆ é¡˜æ‚¨çš„æ¯ä¸€å¤©éƒ½å……æ»¿æ­¡ç¬‘èˆ‡å¹¸ç¦
ğŸˆ é¡˜æ‰€æœ‰ç¾å¥½çš„äº‹ç‰©éƒ½å±¬æ–¼æ‚¨

ç‚ºæ…¶ç¥æ‚¨çš„ç”Ÿæ—¥ï¼Œæˆ‘å€‘ç‰¹åˆ¥æº–å‚™äº†å°ˆå±¬å„ªæƒ ï¼
æœŸå¾…æ‚¨çš„å…‰è‡¨ï¼Œè®“æˆ‘å€‘ä¸€èµ·æ…¶ç¥ï¼`
            };

            // Festival selection
            document.querySelectorAll('.festival-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.festival-btn').forEach(b => {
                        b.classList.remove('selected');
                        b.style.borderColor = '#e2e8f0';
                        b.style.background = 'white';
                    });
                    btn.classList.add('selected');
                    btn.style.borderColor = '#5CADAD';
                    btn.style.background = '#e8f5f5';
                    selectedFestival = btn.dataset.festival;

                    // è‡ªå‹•å¡«å…¥ç¯„ä¾‹è¨Šæ¯
                    const messageTextarea = document.getElementById('custom-message');
                    if (festivalMessages[selectedFestival]) {
                        messageTextarea.value = festivalMessages[selectedFestival];
                    }
                });
            });

            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', (e) => {
                document.querySelectorAll('.customer-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });

            // Send greeting button
            document.getElementById('send-greeting-btn').addEventListener('click', async () => {
                if (!selectedFestival) {
                    alert('è«‹å…ˆé¸æ“‡ç¯€æ…¶');
                    return;
                }

                const selectedCustomers = Array.from(document.querySelectorAll('.customer-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                if (selectedCustomers.length === 0) {
                    alert('è«‹é¸æ“‡è‡³å°‘ä¸€ä½é¡§å®¢');
                    return;
                }

                const customMessage = document.getElementById('custom-message').value;
                const btn = document.getElementById('send-greeting-btn');
                const resultDiv = document.getElementById('send-result');

                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin-right:8px;"></div> ç™¼é€ä¸­...';

                try {
                    const response = await fetch('/email/send-greeting', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer_ids: selectedCustomers,
                            festival: selectedFestival,
                            custom_message: customMessage
                        })
                    });

                    const result = await response.json();

                    resultDiv.innerHTML = `
                        <div class="card" style="background: ${result.success_count > 0 ? '#f0fff4' : '#fff5f5'};">
                            <div class="card-title">ç™¼é€çµæœ</div>
                            <p>æˆåŠŸï¼š${result.success_count} å°</p>
                            <p>å¤±æ•—ï¼š${result.failed_count} å°</p>
                            ${result.failed_count > 0 ? `
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: #666;">æŸ¥çœ‹è©³æƒ…</summary>
                                    <ul style="margin-top: 8px; padding-left: 20px;">
                                        ${result.results.filter(r => !r.success).map(r => `
                                            <li>${r.name}: ${r.error}</li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: #fff5f5;">
                            <div class="card-title">ç™¼é€å¤±æ•—</div>
                            <p>${error.message}</p>
                        </div>
                    `;
                }

                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    ç™¼é€ç¥è³€ä¿¡
                `;
            });
        }

        // Campaigns page initialization
        let campaignCustomers = [];

        async function initCampaignsPage() {
            // Load customers for the modal
            campaignCustomers = await fetchAPI('/customers/');

            // Create campaign button
            document.getElementById('create-campaign-btn').addEventListener('click', () => {
                loadCustomerList();
                document.getElementById('campaign-modal').style.display = 'flex';
            });

            // Campaign form submission
            document.getElementById('campaign-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const recipientMode = formData.get('recipient_mode');

                const data = {
                    name: formData.get('name'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    course_type_filter: formData.get('course_type_filter'),
                    purchase_status_filter: formData.get('purchase_status_filter'),
                    use_filter: recipientMode === 'filter' || recipientMode === 'both',
                    customer_ids: null,
                    additional_emails: null
                };

                // å¦‚æœæ˜¯æ‰‹å‹•é¸æ“‡æˆ–å…©è€…çš†ç”¨æ¨¡å¼
                if (recipientMode === 'manual' || recipientMode === 'both') {
                    // å–å¾—é¸ä¸­çš„é¡§å®¢
                    const selectedCustomers = Array.from(document.querySelectorAll('.campaign-customer-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedCustomers.length > 0) {
                        data.customer_ids = selectedCustomers;
                    }

                    // å–å¾—é¡å¤–çš„ email
                    const additionalEmails = formData.get('additional_emails');
                    if (additionalEmails && additionalEmails.trim()) {
                        data.additional_emails = additionalEmails.split('\n')
                            .map(e => e.trim())
                            .filter(e => e && e.includes('@'));
                    }
                }

                // åƒ…æ‰‹å‹•æ¨¡å¼æ™‚ä¸ä½¿ç”¨ç¯©é¸
                if (recipientMode === 'manual') {
                    data.use_filter = false;
                }

                try {
                    const response = await fetch('/campaigns/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        closeCampaignModal();
                        document.querySelector('[data-page="campaigns"]').click();
                    } else {
                        alert('å»ºç«‹å¤±æ•—ï¼š' + (result.detail || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                } catch (error) {
                    alert('å»ºç«‹å¤±æ•—ï¼š' + error.message);
                }
            });
        }

        function loadCustomerList() {
            const container = document.getElementById('customer-list');
            const customersWithEmail = campaignCustomers.filter(c => c.email);

            if (customersWithEmail.length === 0) {
                container.innerHTML = '<div style="padding:12px;color:#666;text-align:center;">æ²’æœ‰é¡§å®¢è³‡æ–™</div>';
                return;
            }

            container.innerHTML = customersWithEmail.map(c => `
                <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                    <input type="checkbox" class="campaign-customer-checkbox" value="${c.id}">
                    <span style="flex:1;">${c.name}</span>
                    <span style="color:#666;font-size:12px;">${c.email}</span>
                </label>
            `).join('');
        }

        function toggleRecipientMode(mode) {
            const filterSection = document.getElementById('filter-section');
            const manualSection = document.getElementById('manual-section');

            if (mode === 'filter') {
                filterSection.style.display = 'flex';
                manualSection.style.display = 'none';
            } else if (mode === 'manual') {
                filterSection.style.display = 'none';
                manualSection.style.display = 'block';
            } else {
                // both
                filterSection.style.display = 'flex';
                manualSection.style.display = 'block';
            }
        }

        function closeCampaignModal() {
            document.getElementById('campaign-modal').style.display = 'none';
            document.getElementById('campaign-form').reset();
        }

        function closeStatsModal() {
            document.getElementById('stats-modal').style.display = 'none';
        }

        // Schedules page initialization
        let scheduleCustomers = [];

        async function initSchedulesPage() {
            // è¼‰å…¥é¡§å®¢åˆ—è¡¨
            scheduleCustomers = await fetchAPI('/customers/');

            document.getElementById('create-schedule-btn').addEventListener('click', () => {
                initDateTimeSelectors();
                loadScheduleCustomerList();
                document.getElementById('schedule-modal').style.display = 'flex';
            });

            // ä»»å‹™é¡å‹é¸æ“‡è®Šæ›´
            document.getElementById('task-type-select').addEventListener('change', (e) => {
                const customDiv = document.getElementById('custom-task-type');
                customDiv.style.display = e.target.value === 'custom' ? 'block' : 'none';

                // ç”Ÿæ—¥ç¥è³€ä¸éœ€è¦é¸æ“‡æ”¶ä»¶äººå’Œéƒµä»¶å…§å®¹
                const needsRecipient = e.target.value !== 'birthday_greeting';
                document.getElementById('recipient-section').style.display = needsRecipient ? 'block' : 'none';
                document.getElementById('email-content-section').style.display = needsRecipient ? 'block' : 'none';
            });

            // é‡è¤‡é »ç‡è®Šæ›´
            document.querySelector('select[name="frequency"]').addEventListener('change', (e) => {
                document.getElementById('weekday-select').style.display = e.target.value === 'weekly' ? 'inline' : 'none';
                document.getElementById('monthday-select').style.display = e.target.value === 'monthly' ? 'inline' : 'none';
            });

            document.getElementById('schedule-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const scheduleType = formData.get('schedule_type');

                // å–å¾—ä»»å‹™é¡å‹
                let taskType = formData.get('task_type');
                if (taskType === 'custom') {
                    taskType = document.getElementById('custom-task-input').value.trim();
                    if (!taskType) {
                        alert('è«‹è¼¸å…¥è‡ªè¨‚ä»»å‹™åç¨±');
                        return;
                    }
                }

                let data = {
                    task_type: taskType,
                    description: formData.get('description'),
                    schedule_type: scheduleType
                };

                // å¦‚æœä¸æ˜¯ç”Ÿæ—¥ç¥è³€ï¼Œéœ€è¦æ”¶ä»¶äººå’Œéƒµä»¶å…§å®¹
                if (taskType !== 'birthday_greeting') {
                    // å–å¾—é¸ä¸­çš„é¡§å®¢
                    const selectedCustomers = Array.from(document.querySelectorAll('.schedule-customer-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedCustomers.length > 0) {
                        data.customer_ids = selectedCustomers;
                    }

                    // å–å¾—é¡å¤–çš„ email
                    const additionalEmails = formData.get('additional_emails');
                    if (additionalEmails && additionalEmails.trim()) {
                        data.additional_emails = additionalEmails.split('\n')
                            .map(e => e.trim())
                            .filter(e => e && e.includes('@'));
                    }

                    // éƒµä»¶å…§å®¹
                    data.email_subject = formData.get('email_subject');
                    data.email_content = formData.get('email_content');

                    // é©—è­‰
                    if (!data.customer_ids?.length && !data.additional_emails?.length) {
                        alert('è«‹é¸æ“‡è‡³å°‘ä¸€ä½æ”¶ä»¶äººæˆ–è¼¸å…¥é¡å¤– Email');
                        return;
                    }
                    if (!data.email_subject || !data.email_content) {
                        alert('è«‹å¡«å¯«éƒµä»¶ä¸»æ—¨å’Œå…§å®¹');
                        return;
                    }
                }

                if (scheduleType === 'once') {
                    // å–®æ¬¡åŸ·è¡Œï¼šçµ„åˆæ—¥æœŸæ™‚é–“
                    const year = formData.get('year');
                    const month = formData.get('month').padStart(2, '0');
                    const day = formData.get('day').padStart(2, '0');
                    const hour = formData.get('hour').padStart(2, '0');
                    const minute = formData.get('minute').padStart(2, '0');
                    data.scheduled_at = `${year}-${month}-${day}T${hour}:${minute}:00`;
                } else {
                    // é‡è¤‡åŸ·è¡Œï¼šçµ„åˆ cron è¡¨é”å¼
                    const frequency = formData.get('frequency');
                    const hour = formData.get('recurring_hour');
                    const minute = formData.get('recurring_minute');

                    if (frequency === 'daily') {
                        data.cron_expression = `${minute} ${hour} * * *`;
                    } else if (frequency === 'weekly') {
                        const weekday = formData.get('weekday');
                        data.cron_expression = `${minute} ${hour} * * ${weekday}`;
                    } else if (frequency === 'monthly') {
                        const monthday = formData.get('monthday');
                        data.cron_expression = `${minute} ${hour} ${monthday} * *`;
                    }
                }

                try {
                    const endpoint = scheduleType === 'once' ? '/schedules/once' : '/schedules/recurring';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        closeScheduleModal();
                        document.querySelector('[data-page="schedules"]').click();
                    } else {
                        alert('å»ºç«‹å¤±æ•—ï¼š' + (result.detail || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                } catch (error) {
                    alert('å»ºç«‹å¤±æ•—ï¼š' + error.message);
                }
            });
        }

        function loadScheduleCustomerList() {
            const container = document.getElementById('schedule-customer-list');
            const customersWithEmail = scheduleCustomers.filter(c => c.email);

            if (customersWithEmail.length === 0) {
                container.innerHTML = '<div style="padding:12px;color:#666;text-align:center;">æ²’æœ‰é¡§å®¢è³‡æ–™</div>';
                return;
            }

            container.innerHTML = customersWithEmail.map(c => `
                <label style="display:flex;align-items:center;gap:8px;padding:6px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                    <input type="checkbox" class="schedule-customer-checkbox" value="${c.id}">
                    <span style="flex:1;font-size:13px;">${c.name}</span>
                    <span style="color:#666;font-size:11px;">${c.email}</span>
                </label>
            `).join('');
        }

        function initDateTimeSelectors() {
            const now = new Date();
            const currentYear = now.getFullYear();

            // å¹´ä»½é¸æ“‡ï¼ˆä»Šå¹´å’Œæ˜å¹´ï¼‰
            const yearSelect = document.querySelector('select[name="year"]');
            yearSelect.innerHTML = '';
            for (let y = currentYear; y <= currentYear + 2; y++) {
                yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}å¹´</option>`;
            }

            // æœˆä»½é¸æ“‡
            const monthSelect = document.querySelector('select[name="month"]');
            monthSelect.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                monthSelect.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>${m}æœˆ</option>`;
            }

            // æ—¥æœŸé¸æ“‡
            const daySelect = document.querySelector('select[name="day"]');
            updateDayOptions();

            // å°æ™‚é¸æ“‡
            const hourSelect = document.querySelector('select[name="hour"]');
            const recurringHourSelect = document.querySelector('select[name="recurring_hour"]');
            hourSelect.innerHTML = '';
            recurringHourSelect.innerHTML = '';
            for (let h = 0; h <= 23; h++) {
                const hStr = h.toString().padStart(2, '0');
                const selected = h === 9 ? 'selected' : '';
                hourSelect.innerHTML += `<option value="${h}" ${selected}>${hStr}æ™‚</option>`;
                recurringHourSelect.innerHTML += `<option value="${h}" ${selected}>${hStr}æ™‚</option>`;
            }

            // åˆ†é˜é¸æ“‡
            const minuteSelect = document.querySelector('select[name="minute"]');
            const recurringMinuteSelect = document.querySelector('select[name="recurring_minute"]');
            minuteSelect.innerHTML = '';
            recurringMinuteSelect.innerHTML = '';
            for (let m = 0; m <= 59; m += 5) {
                const mStr = m.toString().padStart(2, '0');
                const selected = m === 0 ? 'selected' : '';
                minuteSelect.innerHTML += `<option value="${m}" ${selected}>${mStr}åˆ†</option>`;
                recurringMinuteSelect.innerHTML += `<option value="${m}" ${selected}>${mStr}åˆ†</option>`;
            }

            // æ¯æœˆå¹¾è™Ÿé¸æ“‡
            const monthdaySelect = document.querySelector('select[name="monthday"]');
            monthdaySelect.innerHTML = '';
            for (let d = 1; d <= 31; d++) {
                monthdaySelect.innerHTML += `<option value="${d}">${d}è™Ÿ</option>`;
            }

            // æœˆä»½è®Šæ›´æ™‚æ›´æ–°æ—¥æœŸé¸é …
            yearSelect.addEventListener('change', updateDayOptions);
            monthSelect.addEventListener('change', updateDayOptions);
        }

        function updateDayOptions() {
            const year = parseInt(document.querySelector('select[name="year"]').value);
            const month = parseInt(document.querySelector('select[name="month"]').value);
            const daySelect = document.querySelector('select[name="day"]');
            const currentDay = daySelect.value || new Date().getDate();

            const daysInMonth = new Date(year, month, 0).getDate();
            daySelect.innerHTML = '';
            for (let d = 1; d <= daysInMonth; d++) {
                const selected = d === parseInt(currentDay) && d <= daysInMonth ? 'selected' : '';
                daySelect.innerHTML += `<option value="${d}" ${selected}>${d}æ—¥</option>`;
            }
        }

        function toggleScheduleType(type) {
            const once = document.getElementById('once-section');
            const recurring = document.getElementById('recurring-section');
            if (once) once.style.display = type === 'once' ? 'block' : 'none';
            if (recurring) recurring.style.display = type === 'recurring' ? 'block' : 'none';
        }

        function closeScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            const form = document.getElementById('schedule-form');
            const customType = document.getElementById('custom-task-type');
            const weekday = document.getElementById('weekday-select');
            const monthday = document.getElementById('monthday-select');
            const recipient = document.getElementById('recipient-section');
            const emailContent = document.getElementById('email-content-section');

            if (modal) modal.style.display = 'none';
            if (form) form.reset();
            if (customType) customType.style.display = 'none';
            if (weekday) weekday.style.display = 'none';
            if (monthday) monthday.style.display = 'none';
            if (recipient) recipient.style.display = 'none';
            if (emailContent) emailContent.style.display = 'none';
            toggleScheduleType('once');
        }

        // Import page initialization
        function initImportPage() {
            document.getElementById('import-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const resultDiv = document.getElementById('import-result');

                // å–å¾—è¡¨å–®è³‡æ–™
                const formData = new FormData(form);

                // é©—è­‰
                if (!formData.get('file') || !formData.get('file').name) {
                    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
                    return;
                }

                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                submitBtn.disabled = true;
                submitBtn.textContent = 'åŒ¯å…¥ä¸­...';
                resultDiv.style.display = 'none';

                try {
                    const response = await fetch('/admin/upload-csv', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        resultDiv.innerHTML = `
                            <div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;padding:16px;">
                                <div style="font-weight:500;color:#276749;margin-bottom:8px;">åŒ¯å…¥æˆåŠŸ</div>
                                <p style="margin:0;color:#2f855a;">${result.message}</p>
                                ${result.errors && result.errors.length > 0 ? `
                                    <details style="margin-top:12px;">
                                        <summary style="cursor:pointer;color:#666;">è­¦å‘Šè¨Šæ¯ (${result.errors.length})</summary>
                                        <ul style="margin-top:8px;padding-left:20px;color:#c53030;">
                                            ${result.errors.map(err => `<li>${err}</li>`).join('')}
                                        </ul>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                        form.reset();
                    } else {
                        resultDiv.innerHTML = `
                            <div style="background:#fff5f5;border:1px solid #feb2b2;border-radius:8px;padding:16px;">
                                <div style="font-weight:500;color:#c53030;margin-bottom:8px;">åŒ¯å…¥å¤±æ•—</div>
                                <p style="margin:0;color:#9b2c2c;">${result.detail || result.message || 'æœªçŸ¥éŒ¯èª¤'}</p>
                            </div>
                        `;
                    }
                    resultDiv.style.display = 'block';
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div style="background:#fff5f5;border:1px solid #feb2b2;border-radius:8px;padding:16px;">
                            <div style="font-weight:500;color:#c53030;margin-bottom:8px;">é€£ç·šéŒ¯èª¤</div>
                            <p style="margin:0;color:#9b2c2c;">${error.message}</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'åŒ¯å…¥è³‡æ–™';
                }
            });
        }

        // Customer management functions
        function openAddCustomerModal() {
            document.getElementById('add-customer-modal').style.display = 'flex';
            document.getElementById('add-customer-form').reset();
        }

        function closeAddCustomerModal() {
            document.getElementById('add-customer-modal').style.display = 'none';
        }

        async function openEditCustomerModal(customerId) {
            try {
                const response = await fetch(`/customers/detail/${customerId}`);
                const customer = await response.json();

                if (!response.ok) {
                    alert('è¼‰å…¥é¡§å®¢è³‡æ–™å¤±æ•—');
                    return;
                }

                const form = document.getElementById('edit-customer-form');
                form.querySelector('[name="customer_id"]').value = customer.id;
                form.querySelector('[name="name"]').value = customer.name;
                form.querySelector('[name="phone"]').value = customer.phone;
                form.querySelector('[name="email"]').value = customer.email || '';
                form.querySelector('[name="birthday"]').value = customer.birthday || '';
                form.querySelector('[name="complete_course"]').checked = customer.complete_course;
                form.querySelector('[name="complete_purchased"]').checked = customer.complete_purchased;
                form.querySelector('[name="experience_course"]').checked = customer.experience_course;
                form.querySelector('[name="experience_purchased"]').checked = customer.experience_purchased;

                document.getElementById('edit-customer-modal').style.display = 'flex';
            } catch (error) {
                alert('è¼‰å…¥é¡§å®¢è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }

        function closeEditCustomerModal() {
            document.getElementById('edit-customer-modal').style.display = 'none';
        }

        // æ¸²æŸ“é¡§å®¢è¡¨æ ¼åˆ—
        function renderCustomerRows(data) {
            return data.map(c => `
                <tr>
                    <td><input type="checkbox" class="customer-checkbox" value="${c.id}" onchange="updateSelectedCount()"></td>
                    <td>${c.name}</td>
                    <td>${c.phone}</td>
                    <td>${c.email || '-'}</td>
                    <td>${c.birthday}</td>
                    <td>
                        ${c.complete_course_participations.length > 0
                            ? `<span class="badge ${c.purchased_from_complete ? 'badge-success' : 'badge-warning'}">${c.purchased_from_complete ? 'å·²è³¼è²·' : 'æœªè³¼è²·'}</span>`
                            : '-'}
                    </td>
                    <td>
                        ${c.experience_course_participations.length > 0
                            ? `<span class="badge ${c.purchased_from_experience ? 'badge-success' : 'badge-warning'}">${c.purchased_from_experience ? 'å·²è³¼è²·' : 'æœªè³¼è²·'}</span>`
                            : '-'}
                    </td>
                    <td style="white-space:nowrap;">
                        <button onclick="openEditCustomerModal(${c.id})" style="padding:6px 12px;background:#1a365d;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;white-space:nowrap;">ç·¨è¼¯</button>
                    </td>
                </tr>
            `).join('');
        }

        // æ’åºé¡§å®¢åˆ—è¡¨
        function sortCustomers() {
            if (!window.customerData) return;

            const field = document.getElementById('sort-field').value;
            const order = document.getElementById('sort-order').value;

            const sortedData = [...window.customerData].sort((a, b) => {
                let valA, valB;

                switch (field) {
                    case 'name':
                        valA = a.name || '';
                        valB = b.name || '';
                        break;
                    case 'phone':
                        valA = a.phone || '';
                        valB = b.phone || '';
                        break;
                    case 'birthday':
                        valA = a.birthday || '';
                        valB = b.birthday || '';
                        break;
                    case 'created_at':
                        valA = a.created_at || '';
                        valB = b.created_at || '';
                        break;
                    case 'activity_time':
                        // å–æœ€è¿‘ä¸€æ¬¡æ´»å‹•æ™‚é–“
                        const aComplete = a.complete_course_participations[0]?.activity_time || '';
                        const aExp = a.experience_course_participations[0]?.activity_time || '';
                        const bComplete = b.complete_course_participations[0]?.activity_time || '';
                        const bExp = b.experience_course_participations[0]?.activity_time || '';
                        valA = aComplete > aExp ? aComplete : aExp;
                        valB = bComplete > bExp ? bComplete : bExp;
                        break;
                    default:
                        valA = a.name || '';
                        valB = b.name || '';
                }

                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            // æ›´æ–°è¡¨æ ¼å…§å®¹
            const tbody = document.getElementById('customer-tbody');
            tbody.innerHTML = renderCustomerRows(sortedData);

            // é‡ç½®é¸å–ç‹€æ…‹
            updateSelectedCount();
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selected = document.querySelectorAll('.customer-checkbox:checked');
            const count = selected.length;
            const btn = document.getElementById('delete-selected-btn');
            const countSpan = document.getElementById('selected-count');

            if (count > 0) {
                btn.style.display = 'inline-block';
                countSpan.textContent = count;
            } else {
                btn.style.display = 'none';
            }

            // Update select-all checkbox state
            const allCheckboxes = document.querySelectorAll('.customer-checkbox');
            const selectAll = document.getElementById('select-all');
            if (selectAll) {
                selectAll.checked = allCheckboxes.length > 0 && count === allCheckboxes.length;
                selectAll.indeterminate = count > 0 && count < allCheckboxes.length;
            }
        }

        async function deleteSelectedCustomers() {
            const selected = document.querySelectorAll('.customer-checkbox:checked');
            const ids = Array.from(selected).map(cb => parseInt(cb.value));

            if (ids.length === 0) {
                alert('è«‹é¸æ“‡è¦åˆªé™¤çš„é¡§å®¢');
                return;
            }

            if (!confirm(`ç¢ºå®šè¦åˆªé™¤é¸å–çš„ ${ids.length} ä½é¡§å®¢å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                return;
            }

            try {
                const response = await fetch('/customers/', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message);
                    navigateToPage('customers');
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (result.detail || result.message));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        async function deleteAllCustomers() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰é¡§å®¢å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }

            if (!confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡åˆªé™¤æ‰€æœ‰é¡§å®¢è³‡æ–™ï¼')) {
                return;
            }

            try {
                const response = await fetch('/customers/all', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert(result.message);
                    navigateToPage('customers');
                } else {
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (result.detail || result.message));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        function initAnalysisPage() {
            // å»ºç«‹æ”¶å…¥åœ“é¤…åœ–
            const ctx = document.getElementById('revenueChart');
            if (ctx && window.revenueData && typeof Chart !== 'undefined') {
                const { completeRevenue, experienceRevenue } = window.revenueData;

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['å®Œæ•´èª²ç¨‹', 'é«”é©—èª²ç¨‹'],
                        datasets: [{
                            data: [completeRevenue, experienceRevenue],
                            backgroundColor: ['#5CADAD', '#dd6b20'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true,
                                    font: { size: 13 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `NT$ ${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function initCustomersPage() {
            // æ–°å¢é¡§å®¢è¡¨å–®
            const addForm = document.getElementById('add-customer-form');
            if (addForm) {
                addForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(addForm);
                    const data = {
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        email: formData.get('email') || '',
                        birthday: formData.get('birthday') || null,
                        complete_course: formData.get('complete_course') === '1',
                        experience_course: formData.get('experience_course') === '1'
                    };

                    try {
                        const response = await fetch('/customers/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert(result.message);
                            closeAddCustomerModal();
                            navigateToPage('customers');
                        } else {
                            alert('æ–°å¢å¤±æ•—ï¼š' + (result.detail || result.message));
                        }
                    } catch (error) {
                        alert('æ–°å¢å¤±æ•—ï¼š' + error.message);
                    }
                });
            }

            // ç·¨è¼¯é¡§å®¢è¡¨å–®
            const editForm = document.getElementById('edit-customer-form');
            if (editForm) {
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const formData = new FormData(editForm);
                    const customerId = formData.get('customer_id');
                    const data = {
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        email: formData.get('email') || '',
                        birthday: formData.get('birthday') || null,
                        complete_course: formData.get('complete_course') === '1',
                        complete_purchased: formData.get('complete_purchased') === '1',
                        experience_course: formData.get('experience_course') === '1',
                        experience_purchased: formData.get('experience_purchased') === '1'
                    };

                    try {
                        const response = await fetch(`/customers/${customerId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert(result.message);
                            closeEditCustomerModal();
                            navigateToPage('customers');
                        } else {
                            alert('æ›´æ–°å¤±æ•—ï¼š' + (result.detail || result.message));
                        }
                    } catch (error) {
                        alert('æ›´æ–°å¤±æ•—ï¼š' + error.message);
                    }
                });
            }
        }

        async function viewCampaignStats(campaignId) {
            try {
                const stats = await fetchAPI(`/campaigns/${campaignId}/stats`);
                const content = `
                    <div class="card-grid" style="margin-bottom:16px;">
                        <div style="text-align:center;padding:16px;background:#f7fafc;border-radius:8px;">
                            <div style="font-size:24px;font-weight:bold;color:#4a9595;">${stats.sent_count}</div>
                            <div style="font-size:12px;color:#666;">å·²ç™¼é€</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:#f7fafc;border-radius:8px;">
                            <div style="font-size:24px;font-weight:bold;color:#38a169;">${stats.unique_clickers}</div>
                            <div style="font-size:12px;color:#666;">é»æ“Šäººæ•¸</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:#f7fafc;border-radius:8px;">
                            <div style="font-size:24px;font-weight:bold;color:#5CADAD;">${stats.click_rate}%</div>
                            <div style="font-size:12px;color:#666;">é»æ“Šç‡</div>
                        </div>
                    </div>
                    ${stats.links && stats.links.length > 0 ? `
                        <div style="margin-top:16px;">
                            <div style="font-weight:500;margin-bottom:8px;">é€£çµé»æ“Šçµ±è¨ˆ</div>
                            ${stats.links.map(link => `
                                <div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;">
                                    <span style="font-size:12px;color:#666;overflow:hidden;text-overflow:ellipsis;max-width:300px;">${link.original_url}</span>
                                    <span style="font-weight:500;">${link.click_count} æ¬¡</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                document.getElementById('stats-content').innerHTML = content;
                document.getElementById('stats-modal').style.display = 'flex';
            } catch (error) {
                alert('è¼‰å…¥çµ±è¨ˆå¤±æ•—ï¼š' + error.message);
            }
        }

        async function sendCampaignNow(campaignId) {
            if (!confirm('ç¢ºå®šè¦ç«‹å³ç™¼é€æ­¤æ´»å‹•å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/campaigns/${campaignId}/send-now`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.querySelector('[data-page="campaigns"]').click();
                } else {
                    alert('ç™¼é€å¤±æ•—ï¼š' + (result.error || result.detail || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('ç™¼é€å¤±æ•—ï¼š' + error.message);
            }
        }

        async function cancelSchedule(jobId) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤æ’ç¨‹å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/schedules/${jobId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.querySelector('[data-page="schedules"]').click();
                } else {
                    alert('å–æ¶ˆå¤±æ•—ï¼š' + (result.detail || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
            } catch (e) {
                // å¿½ç•¥éŒ¯èª¤
            }
            window.location.href = '/login';
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        async function checkAuth() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return false;
                }
                const data = await response.json();
                // é¡¯ç¤ºä½¿ç”¨è€…åç¨±
                const userInfo = document.getElementById('user-info');
                if (userInfo && data.admin) {
                    userInfo.textContent = data.admin.username;
                }
                return true;
            } catch (e) {
                window.location.href = '/login';
                return false;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const isLoggedIn = await checkAuth();
                if (isLoggedIn) {
                    const hash = window.location.hash.slice(1);
                    const validPages = Object.keys(pages);
                    const targetPage = validPages.includes(hash) ? hash : 'dashboard';
                    await navigateToPage(targetPage);
                }
            } catch (error) {
                document.getElementById('page-content').innerHTML = '<div class="card"><p>è¼‰å…¥éŒ¯èª¤: ' + error.message + '</p></div>';
            }
        });

        // è™•ç†ç€è¦½å™¨çš„ä¸Šä¸€é /ä¸‹ä¸€é 
        window.addEventListener('hashchange', async () => {
            const hash = window.location.hash.slice(1);
            const validPages = Object.keys(pages);
            if (validPages.includes(hash)) {
                await navigateToPage(hash);
            }
        });
    </script>
</body>
</html>
