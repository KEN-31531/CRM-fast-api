<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM 系統</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>CRM 系統</h1>
                <p>顧客關係管理</p>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 12px;">
                    <span id="user-info" style="opacity: 0.8;"></span>
                    <button onclick="logout()" style="margin-left: 10px; padding: 4px 8px; background: rgba(255,255,255,0.2); border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 12px;">登出</button>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">主要功能</div>
                    <a class="nav-item active" data-page="dashboard">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        儀表板
                    </a>
                    <a class="nav-item" data-page="customers">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        顧客列表
                    </a>
                    <a class="nav-item" data-page="courses">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        課程管理
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">數據分析</div>
                    <a class="nav-item" data-page="analysis">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        購買分析
                    </a>
                    <a class="nav-item" data-page="conversion">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        轉換率分析
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">行銷工具</div>
                    <a class="nav-item" data-page="greeting">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        節慶祝賀
                    </a>
                    <a class="nav-item" data-page="campaigns">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                        </svg>
                        廣告活動
                    </a>
                    <a class="nav-item" data-page="schedules">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        排程管理
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">系統管理</div>
                    <a class="nav-item" data-page="import">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        匯入資料
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div id="page-content">
                <div class="loading">
                    <div class="spinner"></div>
                    載入中...
                </div>
            </div>
        </main>
    </div>

    <script>
        // API Base URL
        const API_BASE = '';

        // Page templates
        const pages = {
            dashboard: async () => {
                const data = await fetchAPI('/analysis/activity-correlation');
                return `
                    <div class="page-header">
                        <h2>儀表板</h2>
                        <p>CRM 系統總覽</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">完整課程參與</div>
                                    <div class="card-value">${data.summary['完整課程']['參與人數']}</div>
                                    <div class="card-subtitle">購買率 ${data.summary['完整課程']['購買率']}</div>
                                </div>
                                <div class="card-icon blue">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">體驗課程參與</div>
                                    <div class="card-value">${data.summary['體驗課程']['參與人數']}</div>
                                    <div class="card-subtitle">購買率 ${data.summary['體驗課程']['購買率']}</div>
                                </div>
                                <div class="card-icon green">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">完整課程購買</div>
                                    <div class="card-value">${data.summary['完整課程']['購買人數']}</div>
                                    <div class="card-subtitle">人</div>
                                </div>
                                <div class="card-icon orange">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">體驗課程購買</div>
                                    <div class="card-value">${data.summary['體驗課程']['購買人數']}</div>
                                    <div class="card-subtitle">人</div>
                                </div>
                                <div class="card-icon teal">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="insights-container">
                        <div class="insights-title">數據洞察</div>
                        ${data.insights.map(insight => `
                            <div class="insight-item">
                                <div class="insight-icon">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="insight-text">${insight}</div>
                            </div>
                        `).join('')}
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div class="insight-text">同時參加兩種課程的顧客數：${data.customer_overlap['同時參加兩種課程的顧客數']} 人</div>
                        </div>
                    </div>
                `;
            },

            customers: async () => {
                const data = await fetchAPI('/customers/');
                return `
                    <div class="page-header">
                        <h2>顧客列表</h2>
                        <p>所有顧客及其活動參與記錄</p>
                    </div>
                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">顧客資料 (${data.length} 筆)</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>姓名</th>
                                    <th>電話</th>
                                    <th>Email</th>
                                    <th>生日</th>
                                    <th>完整課程</th>
                                    <th>體驗課程</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td>${c.phone}</td>
                                        <td>${c.email || '-'}</td>
                                        <td>${c.birthday}</td>
                                        <td>
                                            ${c.complete_course_participations.length > 0
                                                ? `<span class="badge ${c.purchased_from_complete ? 'badge-success' : 'badge-warning'}">${c.purchased_from_complete ? '已購買' : '未購買'}</span>`
                                                : '-'}
                                        </td>
                                        <td>
                                            ${c.experience_course_participations.length > 0
                                                ? `<span class="badge ${c.purchased_from_experience ? 'badge-success' : 'badge-warning'}">${c.purchased_from_experience ? '已購買' : '未購買'}</span>`
                                                : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            courses: async () => {
                const complete = await fetchAPI('/customers/');
                const completeCourse = complete.filter(c => c.complete_course_participations.length > 0);
                const experienceCourse = complete.filter(c => c.experience_course_participations.length > 0);

                return `
                    <div class="page-header">
                        <h2>課程管理</h2>
                        <p>課程參與狀況</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">聖誕節蛋糕製作完整課程</div>
                            <div class="card-value">${completeCourse.length} <span style="font-size:1rem;color:#666">人參與</span></div>
                        </div>
                        <div class="card">
                            <div class="card-title">聖誕節蛋糕製作體驗課程</div>
                            <div class="card-value">${experienceCourse.length} <span style="font-size:1rem;color:#666">人參與</span></div>
                        </div>
                    </div>
                `;
            },

            analysis: async () => {
                const data = await fetchAPI('/analysis/summary');
                return `
                    <div class="page-header">
                        <h2>購買分析</h2>
                        <p>課程購買統計</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">完整課程購買率</div>
                            <div class="card-value">${data.complete_course_purchase_rate}%</div>
                            <div class="card-subtitle">${data.complete_course_purchased_count} / ${data.total_complete_course_participants} 人購買</div>
                        </div>
                        <div class="card">
                            <div class="card-title">體驗課程購買率</div>
                            <div class="card-value">${data.experience_course_purchase_rate}%</div>
                            <div class="card-subtitle">${data.experience_course_purchased_count} / ${data.total_experience_course_participants} 人購買</div>
                        </div>
                    </div>
                    <div class="insights-container">
                        <div class="insights-title">顧客重疊分析</div>
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                            </div>
                            <div class="insight-text">同時參加兩種課程：${data.customers_in_both} 人</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                </svg>
                            </div>
                            <div class="insight-text">只參加完整課程：${data.customers_only_complete} 人</div>
                        </div>
                        <div class="insight-item">
                            <div class="insight-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="insight-text">只參加體驗課程：${data.customers_only_experience} 人</div>
                        </div>
                    </div>
                `;
            },

            conversion: async () => {
                const data = await fetchAPI('/analysis/conversion');
                return `
                    <div class="page-header">
                        <h2>轉換率分析</h2>
                        <p>體驗課程到完整課程的轉換追蹤</p>
                    </div>
                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">體驗課程參與者</div>
                            <div class="card-value">${data.experience_participants}</div>
                            <div class="card-subtitle">人</div>
                        </div>
                        <div class="card">
                            <div class="card-title">體驗後購買完整課程</div>
                            <div class="card-value">${data.experience_to_complete_purchase}</div>
                            <div class="card-subtitle">人</div>
                        </div>
                        <div class="card">
                            <div class="card-title">轉換率</div>
                            <div class="card-value">${data.experience_to_complete_rate}%</div>
                            <div class="card-subtitle">體驗 → 完整課程</div>
                        </div>
                        <div class="card">
                            <div class="card-title">僅體驗課程購買</div>
                            <div class="card-value">${data.experience_only_purchased}</div>
                            <div class="card-subtitle">人</div>
                        </div>
                    </div>
                `;
            },

            greeting: async () => {
                const [festivals, customers] = await Promise.all([
                    fetchAPI('/email/festivals'),
                    fetchAPI('/customers/')
                ]);

                return `
                    <div class="page-header">
                        <h2>節慶祝賀</h2>
                        <p>發送節慶祝賀信給顧客</p>
                    </div>

                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title" style="margin-bottom: 16px;">選擇節慶</div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            ${festivals.map(f => `
                                <button class="festival-btn" data-festival="${f.id}" style="
                                    padding: 12px 24px;
                                    border: 2px solid #e2e8f0;
                                    border-radius: 8px;
                                    background: white;
                                    cursor: pointer;
                                    font-size: 16px;
                                    transition: all 0.2s;
                                " onmouseover="this.style.borderColor='#3182ce'" onmouseout="this.style.borderColor=this.classList.contains('selected')?'#3182ce':'#e2e8f0'">
                                    ${f.emoji} ${f.name}
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-title" style="margin-bottom: 16px;">自訂訊息（選填）</div>
                        <textarea id="custom-message" placeholder="輸入額外的祝福訊息..." style="
                            width: 100%;
                            min-height: 100px;
                            padding: 12px;
                            border: 1px solid #e2e8f0;
                            border-radius: 8px;
                            font-size: 14px;
                            resize: vertical;
                        "></textarea>
                    </div>

                    <div class="card" style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="card-title">選擇顧客</div>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="select-all" style="width: 18px; height: 18px;">
                                全選
                            </label>
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${customers.filter(c => c.email).map(c => `
                                <label style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer;">
                                    <input type="checkbox" class="customer-checkbox" value="${c.id}" style="width: 18px; height: 18px;">
                                    <span style="flex: 1;">${c.name}</span>
                                    <span style="color: #666; font-size: 14px;">${c.email}</span>
                                </label>
                            `).join('')}
                        </div>
                        <p style="color: #666; font-size: 14px; margin-top: 12px;">
                            共 ${customers.filter(c => c.email).length} 位顧客有 Email
                        </p>
                    </div>

                    <button id="send-greeting-btn" style="
                        background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 100%);
                        color: white;
                        border: none;
                        padding: 14px 32px;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    ">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                        </svg>
                        發送祝賀信
                    </button>

                    <div id="send-result" style="margin-top: 24px;"></div>
                `;
            },

            campaigns: async () => {
                const campaigns = await fetchAPI('/campaigns/');
                const statusMap = {
                    'draft': { text: '草稿', class: 'badge-warning' },
                    'scheduled': { text: '已排程', class: 'badge-info' },
                    'sending': { text: '發送中', class: 'badge-info' },
                    'completed': { text: '已完成', class: 'badge-success' },
                    'cancelled': { text: '已取消', class: 'badge-error' }
                };

                return `
                    <div class="page-header">
                        <h2>廣告活動</h2>
                        <p>建立和管理行銷廣告活動</p>
                    </div>

                    <button id="create-campaign-btn" style="
                        background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 100%);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        margin-bottom: 24px;
                    ">+ 建立新活動</button>

                    <div class="table-container">
                        <div class="table-header">
                            <div class="table-title">活動列表 (${campaigns.length} 筆)</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>活動名稱</th>
                                    <th>狀態</th>
                                    <th>篩選條件</th>
                                    <th>收件人數</th>
                                    <th>已發送</th>
                                    <th>點擊率</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${campaigns.length === 0 ? `
                                    <tr><td colspan="7" style="text-align:center;color:#666;">尚無活動</td></tr>
                                ` : campaigns.map(c => `
                                    <tr>
                                        <td>${c.name}</td>
                                        <td><span class="badge ${statusMap[c.status]?.class || ''}">${statusMap[c.status]?.text || c.status}</span></td>
                                        <td style="font-size:12px;color:#666;">
                                            ${c.course_type_filter === 'all' ? '全部課程' : c.course_type_filter === 'complete' ? '完整課程' : '體驗課程'}
                                            /
                                            ${c.purchase_status_filter === 'all' ? '全部' : c.purchase_status_filter === 'purchased' ? '已購買' : '未購買'}
                                        </td>
                                        <td>${c.total_recipients}</td>
                                        <td>${c.sent_count}</td>
                                        <td>${c.sent_count > 0 ? Math.round((c.sent_count - c.failed_count) / c.sent_count * 100) : 0}%</td>
                                        <td>
                                            <button onclick="viewCampaignStats(${c.id})" style="padding:4px 8px;font-size:12px;cursor:pointer;">統計</button>
                                            ${c.status === 'draft' ? `
                                                <button onclick="sendCampaignNow(${c.id})" style="padding:4px 8px;font-size:12px;cursor:pointer;background:#3182ce;color:white;border:none;border-radius:4px;">發送</button>
                                            ` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div id="campaign-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;padding:24px;">
                            <h3 style="margin:0 0 20px;">建立廣告活動</h3>
                            <form id="campaign-form">
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">活動名稱</label>
                                    <input type="text" name="name" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                </div>
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">郵件主旨</label>
                                    <input type="text" name="subject" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                </div>

                                <!-- 收件人選擇區 -->
                                <div style="background:#f7fafc;border-radius:8px;padding:16px;margin-bottom:16px;">
                                    <div style="font-weight:500;margin-bottom:12px;">收件人設定</div>

                                    <!-- 選擇方式 -->
                                    <div style="display:flex;gap:16px;margin-bottom:12px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="recipient_mode" value="filter" checked onchange="toggleRecipientMode(this.value)">
                                            <span>使用篩選條件</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="recipient_mode" value="manual" onchange="toggleRecipientMode(this.value)">
                                            <span>手動選擇</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="recipient_mode" value="both" onchange="toggleRecipientMode(this.value)">
                                            <span>兩者皆用</span>
                                        </label>
                                    </div>

                                    <!-- 篩選條件區塊 -->
                                    <div id="filter-section" style="display:flex;gap:16px;margin-bottom:12px;">
                                        <div style="flex:1;">
                                            <label style="display:block;margin-bottom:4px;font-size:13px;">課程類型</label>
                                            <select name="course_type_filter" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
                                                <option value="all">全部</option>
                                                <option value="complete">完整課程</option>
                                                <option value="experience">體驗課程</option>
                                            </select>
                                        </div>
                                        <div style="flex:1;">
                                            <label style="display:block;margin-bottom:4px;font-size:13px;">購買狀態</label>
                                            <select name="purchase_status_filter" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;">
                                                <option value="all">全部</option>
                                                <option value="purchased">已購買</option>
                                                <option value="not_purchased">未購買</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- 手動選擇區塊 -->
                                    <div id="manual-section" style="display:none;">
                                        <label style="display:block;margin-bottom:4px;font-size:13px;">選擇學員</label>
                                        <div id="customer-list" style="max-height:150px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:white;margin-bottom:12px;"></div>

                                        <label style="display:block;margin-bottom:4px;font-size:13px;">額外 Email（每行一個）</label>
                                        <textarea name="additional_emails" rows="3" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;" placeholder="email1@example.com&#10;email2@example.com"></textarea>
                                    </div>
                                </div>

                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">郵件內容 (HTML)</label>
                                    <textarea name="content" rows="8" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;font-family:monospace;" placeholder="<h1>標題</h1>
<p>親愛的 {{name}} 您好，</p>
<p>內容...</p>
<a href='https://example.com'>點此了解更多</a>"></textarea>
                                    <p style="font-size:12px;color:#666;margin-top:4px;">使用 {{name}} 插入收件人姓名</p>
                                </div>
                                <div style="display:flex;gap:12px;justify-content:flex-end;">
                                    <button type="button" onclick="closeCampaignModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;">取消</button>
                                    <button type="submit" style="padding:10px 20px;border:none;border-radius:6px;background:#1a365d;color:white;cursor:pointer;">建立活動</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="stats-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:500px;width:90%;padding:24px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                                <h3 style="margin:0;">活動統計</h3>
                                <button onclick="closeStatsModal()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                            </div>
                            <div id="stats-content"></div>
                        </div>
                    </div>
                `;
            },

            schedules: async () => {
                const schedules = await fetchAPI('/schedules/');
                const statusMap = {
                    'pending': { text: '待執行', class: 'badge-warning' },
                    'running': { text: '執行中', class: 'badge-info' },
                    'completed': { text: '已完成', class: 'badge-success' },
                    'failed': { text: '失敗', class: 'badge-error' },
                    'cancelled': { text: '已取消', class: 'badge-error' }
                };

                return `
                    <div class="page-header">
                        <h2>排程管理</h2>
                        <p>管理自動化任務和排程</p>
                    </div>

                    <button id="create-schedule-btn" style="
                        background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 100%);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-size: 14px;
                        cursor: pointer;
                        margin-bottom: 24px;
                    ">+ 新增重複排程</button>

                    <div class="card-grid">
                        <div class="card">
                            <div class="card-title">待執行任務</div>
                            <div class="card-value">${schedules.filter(s => s.status === 'pending').length}</div>
                        </div>
                        <div class="card">
                            <div class="card-title">重複任務</div>
                            <div class="card-value">${schedules.filter(s => s.is_recurring).length}</div>
                        </div>
                        <div class="card">
                            <div class="card-title">已完成</div>
                            <div class="card-value">${schedules.filter(s => s.status === 'completed').length}</div>
                        </div>
                    </div>

                    <div class="table-container" style="margin-top:24px;">
                        <div class="table-header">
                            <div class="table-title">排程任務列表</div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>任務類型</th>
                                    <th>說明</th>
                                    <th>排程時間</th>
                                    <th>下次執行</th>
                                    <th>狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${schedules.length === 0 ? `
                                    <tr><td colspan="6" style="text-align:center;color:#666;">尚無排程任務</td></tr>
                                ` : schedules.map(s => {
                                    const taskTypeMap = {
                                        'campaign': '廣告活動',
                                        'campaign_send': '廣告活動發送',
                                        'birthday_greeting': '生日祝賀',
                                        'reminder_email': '提醒郵件'
                                    };
                                    const taskTypeName = taskTypeMap[s.task_type] || s.task_type;
                                    return `
                                    <tr>
                                        <td>${taskTypeName}</td>
                                        <td>${s.description || '-'}</td>
                                        <td>${s.scheduled_at ? new Date(s.scheduled_at).toLocaleString('zh-TW') : (s.cron_expression || '-')}</td>
                                        <td>${s.next_run_at ? new Date(s.next_run_at).toLocaleString('zh-TW') : '-'}</td>
                                        <td><span class="badge ${statusMap[s.status]?.class || ''}">${statusMap[s.status]?.text || s.status}</span></td>
                                        <td>
                                            ${s.status === 'pending' ? `
                                                <button onclick="cancelSchedule('${s.job_id}')" style="padding:4px 8px;font-size:12px;cursor:pointer;background:#e53e3e;color:white;border:none;border-radius:4px;">取消</button>
                                            ` : '-'}
                                        </td>
                                    </tr>
                                `;}).join('')}
                            </tbody>
                        </table>
                    </div>

                    <!-- 新增排程對話框 -->
                    <div id="schedule-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
                        <div style="background:white;border-radius:12px;max-width:550px;width:90%;max-height:90vh;overflow-y:auto;padding:24px;">
                            <h3 style="margin:0 0 20px;">新增排程</h3>
                            <form id="schedule-form">
                                <!-- 排程類型 -->
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">排程類型</label>
                                    <div style="display:flex;gap:16px;">
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="schedule_type" value="once" checked onchange="toggleScheduleType(this.value)">
                                            <span>單次執行</span>
                                        </label>
                                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                                            <input type="radio" name="schedule_type" value="recurring" onchange="toggleScheduleType(this.value)">
                                            <span>重複執行</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- 任務類型 -->
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">任務類型</label>
                                    <div style="display:flex;gap:8px;">
                                        <select id="task-type-select" name="task_type" style="flex:1;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                            <option value="birthday_greeting">生日祝賀郵件</option>
                                            <option value="campaign_send">廣告活動發送</option>
                                            <option value="reminder_email">提醒郵件</option>
                                            <option value="custom">自訂任務...</option>
                                        </select>
                                    </div>
                                    <div id="custom-task-type" style="display:none;margin-top:8px;">
                                        <input type="text" id="custom-task-input" placeholder="輸入自訂任務名稱" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                    </div>
                                </div>

                                <!-- 排程說明 -->
                                <div style="margin-bottom:16px;">
                                    <label style="display:block;margin-bottom:4px;font-weight:500;">排程說明</label>
                                    <input type="text" name="description" required placeholder="例如：發送新年促銷活動" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                </div>

                                <!-- 收件人設定（非生日祝賀時顯示） -->
                                <div id="recipient-section" style="display:none;background:#f7fafc;border-radius:8px;padding:16px;margin-bottom:16px;">
                                    <div style="font-weight:500;margin-bottom:12px;">收件人設定</div>

                                    <label style="display:block;margin-bottom:4px;font-size:13px;">選擇顧客</label>
                                    <div id="schedule-customer-list" style="max-height:120px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:6px;background:white;margin-bottom:12px;"></div>

                                    <label style="display:block;margin-bottom:4px;font-size:13px;">額外 Email（每行一個）</label>
                                    <textarea name="additional_emails" rows="2" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;" placeholder="email1@example.com"></textarea>
                                </div>

                                <!-- 郵件內容（非生日祝賀時顯示） -->
                                <div id="email-content-section" style="display:none;margin-bottom:16px;">
                                    <div style="margin-bottom:12px;">
                                        <label style="display:block;margin-bottom:4px;font-weight:500;">郵件主旨</label>
                                        <input type="text" name="email_subject" placeholder="輸入郵件主旨" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                    </div>
                                    <div>
                                        <label style="display:block;margin-bottom:4px;font-weight:500;">郵件內容 (HTML)</label>
                                        <textarea name="email_content" rows="5" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;font-family:monospace;font-size:13px;" placeholder="<p>親愛的 {{name}} 您好，</p>&#10;<p>內容...</p>"></textarea>
                                        <p style="font-size:12px;color:#666;margin-top:4px;">使用 {{name}} 插入收件人姓名</p>
                                    </div>
                                </div>

                                <!-- 單次執行：日期時間選擇 -->
                                <div id="once-section">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">執行時間</label>
                                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                                        <select name="year" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:90px;"></select>
                                        <select name="month" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <select name="day" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <select name="hour" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <select name="minute" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                    </div>
                                </div>

                                <!-- 重複執行：頻率設定 -->
                                <div id="recurring-section" style="display:none;">
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">重複頻率</label>
                                    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;">
                                        <select name="frequency" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                            <option value="daily">每天</option>
                                            <option value="weekly">每週</option>
                                            <option value="monthly">每月</option>
                                        </select>
                                        <span id="weekday-select" style="display:none;">
                                            <select name="weekday" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                                <option value="1">週一</option>
                                                <option value="2">週二</option>
                                                <option value="3">週三</option>
                                                <option value="4">週四</option>
                                                <option value="5">週五</option>
                                                <option value="6">週六</option>
                                                <option value="0">週日</option>
                                            </select>
                                        </span>
                                        <span id="monthday-select" style="display:none;">
                                            <select name="monthday" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                            </select>
                                        </span>
                                    </div>
                                    <label style="display:block;margin-bottom:8px;font-weight:500;">執行時間</label>
                                    <div style="display:flex;gap:8px;align-items:center;">
                                        <select name="recurring_hour" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                        <span>:</span>
                                        <select name="recurring_minute" style="padding:10px;border:1px solid #e2e8f0;border-radius:6px;min-width:70px;"></select>
                                    </div>
                                </div>

                                <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:24px;">
                                    <button type="button" onclick="closeScheduleModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:6px;background:white;cursor:pointer;">取消</button>
                                    <button type="submit" style="padding:10px 20px;border:none;border-radius:6px;background:#1a365d;color:white;cursor:pointer;">建立排程</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
            },

            import: async () => {
                return `
                    <div class="page-header">
                        <h2>匯入資料</h2>
                        <p>上傳 CSV 檔案匯入顧客資料</p>
                    </div>

                    <div class="card" style="max-width: 600px;">
                        <div class="card-title">上傳 CSV 檔案</div>
                        <form id="import-form" style="margin-top: 16px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display:block;margin-bottom:8px;font-weight:500;">課程名稱</label>
                                <input type="text" name="course_name" required
                                    placeholder="例如：聖誕節蛋糕製作完整課程"
                                    style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display:block;margin-bottom:8px;font-weight:500;">課程類型</label>
                                <select name="course_type" required style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;">
                                    <option value="">請選擇...</option>
                                    <option value="完整課程">完整課程</option>
                                    <option value="體驗課程">體驗課程</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display:block;margin-bottom:8px;font-weight:500;">選擇 CSV 檔案</label>
                                <input type="file" name="file" accept=".csv" required
                                    style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:6px;box-sizing:border-box;">
                                <p style="margin-top:8px;font-size:12px;color:#666;">
                                    CSV 格式：姓名,電話,Email,生日,參加活動時間,是否購買課程
                                </p>
                            </div>

                            <button type="submit" style="
                                width: 100%;
                                padding: 12px;
                                background: linear-gradient(135deg, #1a365d 0%, #2d4a6f 100%);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                cursor: pointer;
                            ">匯入資料</button>
                        </form>

                        <div id="import-result" style="margin-top: 16px; display: none;"></div>
                    </div>

                    <div class="card" style="max-width: 600px; margin-top: 24px;">
                        <div class="card-title">CSV 格式範例</div>
                        <pre style="background:#f7fafc;padding:12px;border-radius:6px;font-size:12px;overflow-x:auto;margin-top:12px;">姓名,電話,Email,生日,參加活動時間,是否購買課程
王小明,0912345678,wang@example.com,1990/01/15,2024/12/25 14:00,是
李小華,0923456789,li@example.com,1985/05/20,2024/12/25 14:00,否</pre>
                    </div>
                `;
            }
        };

        // Fetch API helper
        async function fetchAPI(endpoint) {
            const res = await fetch(API_BASE + endpoint);
            return res.json();
        }

        // Navigation
        async function navigateToPage(page) {
            // Update URL hash
            window.location.hash = page;

            // Update active state
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeItem = document.querySelector(`[data-page="${page}"]`);
            if (activeItem) activeItem.classList.add('active');

            // Show loading
            document.getElementById('page-content').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    載入中...
                </div>
            `;

            // Load page
            try {
                const content = await pages[page]();
                document.getElementById('page-content').innerHTML = content;

                // Page-specific initialization
                if (page === 'greeting') {
                    initGreetingPage();
                } else if (page === 'campaigns') {
                    initCampaignsPage();
                } else if (page === 'schedules') {
                    initSchedulesPage();
                } else if (page === 'import') {
                    initImportPage();
                }
            } catch (error) {
                document.getElementById('page-content').innerHTML = `
                    <div class="card">
                        <div class="card-title">錯誤</div>
                        <p>載入資料時發生錯誤：${error.message}</p>
                    </div>
                `;
            }
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', async (e) => {
                e.preventDefault();
                const page = item.dataset.page;
                await navigateToPage(page);
            });
        });

        // Greeting page initialization
        let selectedFestival = null;

        function initGreetingPage() {
            // Festival selection
            document.querySelectorAll('.festival-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.festival-btn').forEach(b => {
                        b.classList.remove('selected');
                        b.style.borderColor = '#e2e8f0';
                        b.style.background = 'white';
                    });
                    btn.classList.add('selected');
                    btn.style.borderColor = '#3182ce';
                    btn.style.background = '#ebf8ff';
                    selectedFestival = btn.dataset.festival;
                });
            });

            // Select all checkbox
            document.getElementById('select-all').addEventListener('change', (e) => {
                document.querySelectorAll('.customer-checkbox').forEach(cb => {
                    cb.checked = e.target.checked;
                });
            });

            // Send greeting button
            document.getElementById('send-greeting-btn').addEventListener('click', async () => {
                if (!selectedFestival) {
                    alert('請先選擇節慶');
                    return;
                }

                const selectedCustomers = Array.from(document.querySelectorAll('.customer-checkbox:checked'))
                    .map(cb => parseInt(cb.value));

                if (selectedCustomers.length === 0) {
                    alert('請選擇至少一位顧客');
                    return;
                }

                const customMessage = document.getElementById('custom-message').value;
                const btn = document.getElementById('send-greeting-btn');
                const resultDiv = document.getElementById('send-result');

                btn.disabled = true;
                btn.innerHTML = '<div class="spinner" style="width:20px;height:20px;border-width:2px;margin-right:8px;"></div> 發送中...';

                try {
                    const response = await fetch('/email/send-greeting', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            customer_ids: selectedCustomers,
                            festival: selectedFestival,
                            custom_message: customMessage
                        })
                    });

                    const result = await response.json();

                    resultDiv.innerHTML = `
                        <div class="card" style="background: ${result.success_count > 0 ? '#f0fff4' : '#fff5f5'};">
                            <div class="card-title">發送結果</div>
                            <p>成功：${result.success_count} 封</p>
                            <p>失敗：${result.failed_count} 封</p>
                            ${result.failed_count > 0 ? `
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: #666;">查看詳情</summary>
                                    <ul style="margin-top: 8px; padding-left: 20px;">
                                        ${result.results.filter(r => !r.success).map(r => `
                                            <li>${r.name}: ${r.error}</li>
                                        `).join('')}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div class="card" style="background: #fff5f5;">
                            <div class="card-title">發送失敗</div>
                            <p>${error.message}</p>
                        </div>
                    `;
                }

                btn.disabled = false;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    發送祝賀信
                `;
            });
        }

        // Campaigns page initialization
        let campaignCustomers = [];

        async function initCampaignsPage() {
            // Load customers for the modal
            campaignCustomers = await fetchAPI('/customers/');

            // Create campaign button
            document.getElementById('create-campaign-btn').addEventListener('click', () => {
                loadCustomerList();
                document.getElementById('campaign-modal').style.display = 'flex';
            });

            // Campaign form submission
            document.getElementById('campaign-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const recipientMode = formData.get('recipient_mode');

                const data = {
                    name: formData.get('name'),
                    subject: formData.get('subject'),
                    content: formData.get('content'),
                    course_type_filter: formData.get('course_type_filter'),
                    purchase_status_filter: formData.get('purchase_status_filter'),
                    use_filter: recipientMode === 'filter' || recipientMode === 'both',
                    customer_ids: null,
                    additional_emails: null
                };

                // 如果是手動選擇或兩者皆用模式
                if (recipientMode === 'manual' || recipientMode === 'both') {
                    // 取得選中的顧客
                    const selectedCustomers = Array.from(document.querySelectorAll('.campaign-customer-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedCustomers.length > 0) {
                        data.customer_ids = selectedCustomers;
                    }

                    // 取得額外的 email
                    const additionalEmails = formData.get('additional_emails');
                    if (additionalEmails && additionalEmails.trim()) {
                        data.additional_emails = additionalEmails.split('\n')
                            .map(e => e.trim())
                            .filter(e => e && e.includes('@'));
                    }
                }

                // 僅手動模式時不使用篩選
                if (recipientMode === 'manual') {
                    data.use_filter = false;
                }

                try {
                    const response = await fetch('/campaigns/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        closeCampaignModal();
                        document.querySelector('[data-page="campaigns"]').click();
                    } else {
                        alert('建立失敗：' + (result.detail || '未知錯誤'));
                    }
                } catch (error) {
                    alert('建立失敗：' + error.message);
                }
            });
        }

        function loadCustomerList() {
            const container = document.getElementById('customer-list');
            const customersWithEmail = campaignCustomers.filter(c => c.email);

            if (customersWithEmail.length === 0) {
                container.innerHTML = '<div style="padding:12px;color:#666;text-align:center;">沒有顧客資料</div>';
                return;
            }

            container.innerHTML = customersWithEmail.map(c => `
                <label style="display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                    <input type="checkbox" class="campaign-customer-checkbox" value="${c.id}">
                    <span style="flex:1;">${c.name}</span>
                    <span style="color:#666;font-size:12px;">${c.email}</span>
                </label>
            `).join('');
        }

        function toggleRecipientMode(mode) {
            const filterSection = document.getElementById('filter-section');
            const manualSection = document.getElementById('manual-section');

            if (mode === 'filter') {
                filterSection.style.display = 'flex';
                manualSection.style.display = 'none';
            } else if (mode === 'manual') {
                filterSection.style.display = 'none';
                manualSection.style.display = 'block';
            } else {
                // both
                filterSection.style.display = 'flex';
                manualSection.style.display = 'block';
            }
        }

        function closeCampaignModal() {
            document.getElementById('campaign-modal').style.display = 'none';
            document.getElementById('campaign-form').reset();
        }

        function closeStatsModal() {
            document.getElementById('stats-modal').style.display = 'none';
        }

        // Schedules page initialization
        let scheduleCustomers = [];

        async function initSchedulesPage() {
            // 載入顧客列表
            scheduleCustomers = await fetchAPI('/customers/');

            document.getElementById('create-schedule-btn').addEventListener('click', () => {
                initDateTimeSelectors();
                loadScheduleCustomerList();
                document.getElementById('schedule-modal').style.display = 'flex';
            });

            // 任務類型選擇變更
            document.getElementById('task-type-select').addEventListener('change', (e) => {
                const customDiv = document.getElementById('custom-task-type');
                customDiv.style.display = e.target.value === 'custom' ? 'block' : 'none';

                // 生日祝賀不需要選擇收件人和郵件內容
                const needsRecipient = e.target.value !== 'birthday_greeting';
                document.getElementById('recipient-section').style.display = needsRecipient ? 'block' : 'none';
                document.getElementById('email-content-section').style.display = needsRecipient ? 'block' : 'none';
            });

            // 重複頻率變更
            document.querySelector('select[name="frequency"]').addEventListener('change', (e) => {
                document.getElementById('weekday-select').style.display = e.target.value === 'weekly' ? 'inline' : 'none';
                document.getElementById('monthday-select').style.display = e.target.value === 'monthly' ? 'inline' : 'none';
            });

            document.getElementById('schedule-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const scheduleType = formData.get('schedule_type');

                // 取得任務類型
                let taskType = formData.get('task_type');
                if (taskType === 'custom') {
                    taskType = document.getElementById('custom-task-input').value.trim();
                    if (!taskType) {
                        alert('請輸入自訂任務名稱');
                        return;
                    }
                }

                let data = {
                    task_type: taskType,
                    description: formData.get('description'),
                    schedule_type: scheduleType
                };

                // 如果不是生日祝賀，需要收件人和郵件內容
                if (taskType !== 'birthday_greeting') {
                    // 取得選中的顧客
                    const selectedCustomers = Array.from(document.querySelectorAll('.schedule-customer-checkbox:checked'))
                        .map(cb => parseInt(cb.value));
                    if (selectedCustomers.length > 0) {
                        data.customer_ids = selectedCustomers;
                    }

                    // 取得額外的 email
                    const additionalEmails = formData.get('additional_emails');
                    if (additionalEmails && additionalEmails.trim()) {
                        data.additional_emails = additionalEmails.split('\n')
                            .map(e => e.trim())
                            .filter(e => e && e.includes('@'));
                    }

                    // 郵件內容
                    data.email_subject = formData.get('email_subject');
                    data.email_content = formData.get('email_content');

                    // 驗證
                    if (!data.customer_ids?.length && !data.additional_emails?.length) {
                        alert('請選擇至少一位收件人或輸入額外 Email');
                        return;
                    }
                    if (!data.email_subject || !data.email_content) {
                        alert('請填寫郵件主旨和內容');
                        return;
                    }
                }

                if (scheduleType === 'once') {
                    // 單次執行：組合日期時間
                    const year = formData.get('year');
                    const month = formData.get('month').padStart(2, '0');
                    const day = formData.get('day').padStart(2, '0');
                    const hour = formData.get('hour').padStart(2, '0');
                    const minute = formData.get('minute').padStart(2, '0');
                    data.scheduled_at = `${year}-${month}-${day}T${hour}:${minute}:00`;
                } else {
                    // 重複執行：組合 cron 表達式
                    const frequency = formData.get('frequency');
                    const hour = formData.get('recurring_hour');
                    const minute = formData.get('recurring_minute');

                    if (frequency === 'daily') {
                        data.cron_expression = `${minute} ${hour} * * *`;
                    } else if (frequency === 'weekly') {
                        const weekday = formData.get('weekday');
                        data.cron_expression = `${minute} ${hour} * * ${weekday}`;
                    } else if (frequency === 'monthly') {
                        const monthday = formData.get('monthday');
                        data.cron_expression = `${minute} ${hour} ${monthday} * *`;
                    }
                }

                try {
                    const endpoint = scheduleType === 'once' ? '/schedules/once' : '/schedules/recurring';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        closeScheduleModal();
                        document.querySelector('[data-page="schedules"]').click();
                    } else {
                        alert('建立失敗：' + (result.detail || '未知錯誤'));
                    }
                } catch (error) {
                    alert('建立失敗：' + error.message);
                }
            });
        }

        function loadScheduleCustomerList() {
            const container = document.getElementById('schedule-customer-list');
            const customersWithEmail = scheduleCustomers.filter(c => c.email);

            if (customersWithEmail.length === 0) {
                container.innerHTML = '<div style="padding:12px;color:#666;text-align:center;">沒有顧客資料</div>';
                return;
            }

            container.innerHTML = customersWithEmail.map(c => `
                <label style="display:flex;align-items:center;gap:8px;padding:6px 12px;border-bottom:1px solid #eee;cursor:pointer;">
                    <input type="checkbox" class="schedule-customer-checkbox" value="${c.id}">
                    <span style="flex:1;font-size:13px;">${c.name}</span>
                    <span style="color:#666;font-size:11px;">${c.email}</span>
                </label>
            `).join('');
        }

        function initDateTimeSelectors() {
            const now = new Date();
            const currentYear = now.getFullYear();

            // 年份選擇（今年和明年）
            const yearSelect = document.querySelector('select[name="year"]');
            yearSelect.innerHTML = '';
            for (let y = currentYear; y <= currentYear + 2; y++) {
                yearSelect.innerHTML += `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}年</option>`;
            }

            // 月份選擇
            const monthSelect = document.querySelector('select[name="month"]');
            monthSelect.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                monthSelect.innerHTML += `<option value="${m}" ${m === now.getMonth() + 1 ? 'selected' : ''}>${m}月</option>`;
            }

            // 日期選擇
            const daySelect = document.querySelector('select[name="day"]');
            updateDayOptions();

            // 小時選擇
            const hourSelect = document.querySelector('select[name="hour"]');
            const recurringHourSelect = document.querySelector('select[name="recurring_hour"]');
            hourSelect.innerHTML = '';
            recurringHourSelect.innerHTML = '';
            for (let h = 0; h <= 23; h++) {
                const hStr = h.toString().padStart(2, '0');
                const selected = h === 9 ? 'selected' : '';
                hourSelect.innerHTML += `<option value="${h}" ${selected}>${hStr}時</option>`;
                recurringHourSelect.innerHTML += `<option value="${h}" ${selected}>${hStr}時</option>`;
            }

            // 分鐘選擇
            const minuteSelect = document.querySelector('select[name="minute"]');
            const recurringMinuteSelect = document.querySelector('select[name="recurring_minute"]');
            minuteSelect.innerHTML = '';
            recurringMinuteSelect.innerHTML = '';
            for (let m = 0; m <= 59; m += 5) {
                const mStr = m.toString().padStart(2, '0');
                const selected = m === 0 ? 'selected' : '';
                minuteSelect.innerHTML += `<option value="${m}" ${selected}>${mStr}分</option>`;
                recurringMinuteSelect.innerHTML += `<option value="${m}" ${selected}>${mStr}分</option>`;
            }

            // 每月幾號選擇
            const monthdaySelect = document.querySelector('select[name="monthday"]');
            monthdaySelect.innerHTML = '';
            for (let d = 1; d <= 31; d++) {
                monthdaySelect.innerHTML += `<option value="${d}">${d}號</option>`;
            }

            // 月份變更時更新日期選項
            yearSelect.addEventListener('change', updateDayOptions);
            monthSelect.addEventListener('change', updateDayOptions);
        }

        function updateDayOptions() {
            const year = parseInt(document.querySelector('select[name="year"]').value);
            const month = parseInt(document.querySelector('select[name="month"]').value);
            const daySelect = document.querySelector('select[name="day"]');
            const currentDay = daySelect.value || new Date().getDate();

            const daysInMonth = new Date(year, month, 0).getDate();
            daySelect.innerHTML = '';
            for (let d = 1; d <= daysInMonth; d++) {
                const selected = d === parseInt(currentDay) && d <= daysInMonth ? 'selected' : '';
                daySelect.innerHTML += `<option value="${d}" ${selected}>${d}日</option>`;
            }
        }

        function toggleScheduleType(type) {
            document.getElementById('once-section').style.display = type === 'once' ? 'block' : 'none';
            document.getElementById('recurring-section').style.display = type === 'recurring' ? 'block' : 'none';
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
            document.getElementById('schedule-form').reset();
            document.getElementById('custom-task-type').style.display = 'none';
            document.getElementById('weekday-select').style.display = 'none';
            document.getElementById('monthday-select').style.display = 'none';
            document.getElementById('recipient-section').style.display = 'none';
            document.getElementById('email-content-section').style.display = 'none';
            toggleScheduleType('once');
        }

        // Import page initialization
        function initImportPage() {
            document.getElementById('import-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const form = e.target;
                const submitBtn = form.querySelector('button[type="submit"]');
                const resultDiv = document.getElementById('import-result');

                // 取得表單資料
                const formData = new FormData(form);

                // 驗證
                if (!formData.get('course_name')) {
                    alert('請輸入課程名稱');
                    return;
                }
                if (!formData.get('course_type')) {
                    alert('請選擇課程類型');
                    return;
                }
                if (!formData.get('file')) {
                    alert('請選擇 CSV 檔案');
                    return;
                }

                // 顯示載入狀態
                submitBtn.disabled = true;
                submitBtn.textContent = '匯入中...';
                resultDiv.style.display = 'none';

                try {
                    const response = await fetch('/admin/upload-csv', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        resultDiv.innerHTML = `
                            <div style="background:#f0fff4;border:1px solid #9ae6b4;border-radius:8px;padding:16px;">
                                <div style="font-weight:500;color:#276749;margin-bottom:8px;">匯入成功</div>
                                <p style="margin:0;color:#2f855a;">${result.message}</p>
                                ${result.errors && result.errors.length > 0 ? `
                                    <details style="margin-top:12px;">
                                        <summary style="cursor:pointer;color:#666;">警告訊息 (${result.errors.length})</summary>
                                        <ul style="margin-top:8px;padding-left:20px;color:#c53030;">
                                            ${result.errors.map(err => `<li>${err}</li>`).join('')}
                                        </ul>
                                    </details>
                                ` : ''}
                            </div>
                        `;
                        form.reset();
                    } else {
                        resultDiv.innerHTML = `
                            <div style="background:#fff5f5;border:1px solid #feb2b2;border-radius:8px;padding:16px;">
                                <div style="font-weight:500;color:#c53030;margin-bottom:8px;">匯入失敗</div>
                                <p style="margin:0;color:#9b2c2c;">${result.detail || result.message || '未知錯誤'}</p>
                            </div>
                        `;
                    }
                    resultDiv.style.display = 'block';
                } catch (error) {
                    resultDiv.innerHTML = `
                        <div style="background:#fff5f5;border:1px solid #feb2b2;border-radius:8px;padding:16px;">
                            <div style="font-weight:500;color:#c53030;margin-bottom:8px;">連線錯誤</div>
                            <p style="margin:0;color:#9b2c2c;">${error.message}</p>
                        </div>
                    `;
                    resultDiv.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = '匯入資料';
                }
            });
        }

        async function viewCampaignStats(campaignId) {
            try {
                const stats = await fetchAPI(`/campaigns/${campaignId}/stats`);
                const content = `
                    <div class="card-grid" style="margin-bottom:16px;">
                        <div style="text-align:center;padding:16px;background:#f7fafc;border-radius:8px;">
                            <div style="font-size:24px;font-weight:bold;color:#1a365d;">${stats.sent_count}</div>
                            <div style="font-size:12px;color:#666;">已發送</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:#f7fafc;border-radius:8px;">
                            <div style="font-size:24px;font-weight:bold;color:#38a169;">${stats.unique_clickers}</div>
                            <div style="font-size:12px;color:#666;">點擊人數</div>
                        </div>
                        <div style="text-align:center;padding:16px;background:#f7fafc;border-radius:8px;">
                            <div style="font-size:24px;font-weight:bold;color:#3182ce;">${stats.click_rate}%</div>
                            <div style="font-size:12px;color:#666;">點擊率</div>
                        </div>
                    </div>
                    ${stats.links && stats.links.length > 0 ? `
                        <div style="margin-top:16px;">
                            <div style="font-weight:500;margin-bottom:8px;">連結點擊統計</div>
                            ${stats.links.map(link => `
                                <div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;">
                                    <span style="font-size:12px;color:#666;overflow:hidden;text-overflow:ellipsis;max-width:300px;">${link.original_url}</span>
                                    <span style="font-weight:500;">${link.click_count} 次</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                document.getElementById('stats-content').innerHTML = content;
                document.getElementById('stats-modal').style.display = 'flex';
            } catch (error) {
                alert('載入統計失敗：' + error.message);
            }
        }

        async function sendCampaignNow(campaignId) {
            if (!confirm('確定要立即發送此活動嗎？')) return;

            try {
                const response = await fetch(`/campaigns/${campaignId}/send-now`, {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.querySelector('[data-page="campaigns"]').click();
                } else {
                    alert('發送失敗：' + (result.error || result.detail || '未知錯誤'));
                }
            } catch (error) {
                alert('發送失敗：' + error.message);
            }
        }

        async function cancelSchedule(jobId) {
            if (!confirm('確定要取消此排程嗎？')) return;

            try {
                const response = await fetch(`/schedules/${jobId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.querySelector('[data-page="schedules"]').click();
                } else {
                    alert('取消失敗：' + (result.detail || '未知錯誤'));
                }
            } catch (error) {
                alert('取消失敗：' + error.message);
            }
        }

        // 登出功能
        async function logout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
            } catch (e) {
                // 忽略錯誤
            }
            window.location.href = '/login';
        }

        // 檢查登入狀態
        async function checkAuth() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return false;
                }
                const data = await response.json();
                // 顯示使用者名稱
                const userInfo = document.getElementById('user-info');
                if (userInfo && data.admin) {
                    userInfo.textContent = data.admin.username;
                }
                return true;
            } catch (e) {
                window.location.href = '/login';
                return false;
            }
        }

        // 初始化
        (async function init() {
            const isLoggedIn = await checkAuth();
            if (isLoggedIn) {
                // 讀取 URL hash 來決定要載入的頁面
                const hash = window.location.hash.slice(1); // 移除 # 符號
                const validPages = Object.keys(pages);
                const targetPage = validPages.includes(hash) ? hash : 'dashboard';
                await navigateToPage(targetPage);
            }
        })();

        // 處理瀏覽器的上一頁/下一頁
        window.addEventListener('hashchange', async () => {
            const hash = window.location.hash.slice(1);
            const validPages = Object.keys(pages);
            if (validPages.includes(hash)) {
                await navigateToPage(hash);
            }
        });
    </script>
</body>
</html>
